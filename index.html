<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">å–æ°´äº†å— | åˆ†ç§’å¿…äº‰</title>
    
    <!-- PWA é…ç½® -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å–æ°´äº†å—">
    <meta name="application-name" content="å–æ°´äº†å—">
    <meta name="theme-color" content="#0a192f">
    <meta name="description" content="æ™ºèƒ½å–æ°´æé†’ï¼Œå…³çˆ±å¥åº·æ¯ä¸€å¤©">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a192f' width='100' height='100' rx='20'/><text x='50' y='68' font-size='55' text-anchor='middle'>ğŸ’§</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2300d4ff' width='100' height='100' rx='20'/><text x='50' y='68' font-size='55' text-anchor='middle'>ğŸ’§</text></svg>">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5Zad5rC05LqG5ZCXIiwic2hvcnRfbmFtZSI6IuWWneawtOS6huWQlyIsImRlc2NyaXB0aW9uIjoi5pm66IO95Zad5rC05o+Q6YaSIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMTkyZiIsInRoZW1lX2NvbG9yIjoiIzAwZDRmZiIsInN0YXJ0X3VybCI6Ii4iLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHJlY3QgZmlsbD0nJTIzMDBkNGZmJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzY4JyBmb250LXNpemU9JzU1JyB0ZXh0LWFuY2hvcj0nbWlkZGxlJz7wn5KnPC90ZXh0Pjwvc3ZnPiIsInNpemVzIjoiYW55IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==">
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #00d4ff; --accent: #ff006e; --gold: #ffd700; --success: #06ffa5; --bg1: #0a192f; --bg2: #112240; --water: #00bcd4; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, 'Noto Sans SC', sans-serif; color: #fff; min-height: 100vh; background: linear-gradient(135deg, var(--bg1), var(--bg2)); }

        .top-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(10,25,47,0.95); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-size: 18px; font-weight: bold; }
        .logo span { background: linear-gradient(90deg, var(--primary), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .top-right { display: flex; gap: 6px; align-items: center; }
        .top-btn { background: rgba(255,255,255,0.1); border: none; padding: 5px 10px; border-radius: 15px; color: white; font-size: 11px; cursor: pointer; }
        .lang-select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; color: white; font-size: 10px; cursor: pointer; }

        .ad-bar { position: fixed; top: 42px; left: 0; right: 0; height: 50px; overflow: hidden; z-index: 99; background: rgba(0,0,0,0.3); }
        .ad-container { display: flex; animation: scrollAds 30s linear infinite; }
        .ad-item { min-width: 100vw; height: 50px; display: flex; align-items: center; justify-content: center; padding: 5px 15px; }
        .ad-item.text { background: linear-gradient(90deg, #667eea, #764ba2); font-size: 13px; }
        .ad-item.image img { max-height: 45px; max-width: 90%; object-fit: contain; }
        .ad-item.video video { max-height: 45px; max-width: 90%; }
        .ad-item.link { background: linear-gradient(90deg, #00d4ff, #8338ec); font-size: 12px; cursor: pointer; }
        @keyframes scrollAds { 0%{transform:translateX(0)}100%{transform:translateX(-100%)} }

        .main { padding: 102px 12px 70px; }

        .culture-card { position: relative; border-radius: 14px; padding: 16px; overflow: hidden; margin-bottom: 12px; }
        .culture-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; background-position: center; filter: brightness(0.35); }
        .culture-content { position: relative; z-index: 1; }
        .culture-label { font-size: 10px; color: var(--gold); margin-bottom: 6px; }
        .culture-text { font-size: 14px; line-height: 1.8; }
        .culture-source { font-size: 10px; color: rgba(255,255,255,0.5); text-align: right; margin-top: 6px; }
        .culture-actions { display: flex; gap: 6px; margin-top: 10px; }
        .culture-btn { flex: 1; padding: 6px; background: rgba(255,255,255,0.15); border: none; border-radius: 15px; color: white; font-size: 10px; cursor: pointer; }

        .checkin-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: linear-gradient(90deg, rgba(255,215,0,0.08), rgba(6,255,165,0.08)); border-radius: 10px; margin-bottom: 15px; }
        .checkin-info { display: flex; align-items: center; gap: 12px; }
        .checkin-streak { font-size: 11px; }
        .checkin-streak strong { color: var(--gold); font-size: 16px; }
        .checkin-points { font-size: 10px; color: var(--success); }
        .checkin-btn { padding: 6px 14px; background: linear-gradient(135deg, var(--gold), #ff8c00); border: none; border-radius: 15px; color: #000; font-size: 11px; font-weight: bold; cursor: pointer; }
        .checkin-btn.done { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); }

        .clock-unit { background: rgba(0,0,0,0.25); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 20px 15px; }
        .clock-area { display: flex; flex-direction: column; align-items: center; }

        .clock-face { position: relative; width: 240px; height: 240px; border-radius: 50%; border: 5px solid var(--primary); box-shadow: 0 0 40px rgba(0,212,255,0.3), inset 0 0 30px rgba(0,0,0,0.5); background: radial-gradient(circle, rgba(10,25,47,0.8), rgba(0,0,0,0.9)); margin-bottom: 15px; }
        .tick { position: absolute; left: 50%; top: 8px; width: 2px; height: 10px; background: rgba(255,255,255,0.4); transform-origin: 0 112px; }
        .tick.major { width: 3px; height: 15px; background: var(--gold); transform-origin: 0 109px; }
        .clock-num { position: absolute; font-size: 15px; font-weight: bold; color: var(--gold); }
        .clock-num.n12 { top: 18px; left: 50%; transform: translateX(-50%); }
        .clock-num.n3 { right: 16px; top: 50%; transform: translateY(-50%); }
        .clock-num.n6 { bottom: 18px; left: 50%; transform: translateX(-50%); }
        .clock-num.n9 { left: 16px; top: 50%; transform: translateY(-50%); }

        .clock-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 110px; height: 110px; border-radius: 50%; background: rgba(0,20,40,0.9); border: 2px solid rgba(255,255,255,0.15); overflow: hidden; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; }
        .center-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; }
        .center-content img, .center-content video { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .center-text { font-size: 10px; line-height: 1.4; padding: 8px; color: rgba(255,255,255,0.85); }
        .center-placeholder { font-size: 9px; color: rgba(255,255,255,0.4); }

        .hand { position: absolute; left: 50%; bottom: 50%; transform-origin: 50% 100%; border-radius: 4px; z-index: 10; }
        .hand-hour { width: 5px; height: 45px; margin-left: -2.5px; background: linear-gradient(to top, var(--primary), #fff); box-shadow: 0 0 10px var(--primary); }
        .hand-minute { width: 4px; height: 65px; margin-left: -2px; background: linear-gradient(to top, #8338ec, #fff); box-shadow: 0 0 8px #8338ec; }
        .hand-second { width: 2px; height: 85px; margin-left: -1px; background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .hand-dot { position: absolute; width: 12px; height: 12px; background: var(--gold); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px var(--gold); z-index: 15; }

        .digital-box { text-align: center; margin-bottom: 12px; }
        .digital-time { font-size: 38px; font-weight: bold; font-family: 'Courier New', monospace; color: var(--primary); text-shadow: 0 0 25px rgba(0,212,255,0.6); letter-spacing: 2px; }
        .digital-time .colon { animation: blink 1s infinite; }
        @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }
        .digital-date { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 5px; }
        .slogan { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 4px; font-style: italic; }

        .tick-bar { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 6px 14px; background: rgba(255,255,255,0.05); border-radius: 18px; cursor: pointer; margin-bottom: 15px; }
        .tick-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 1s infinite; }
        .tick-dot.off { background: #555; animation: none; }
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.3} }

        .func-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .func-btn { display: flex; flex-direction: column; align-items: center; padding: 10px 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; color: white; cursor: pointer; min-width: 55px; }
        .func-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }
        .func-btn .icon { font-size: 22px; }
        .func-btn .label { font-size: 9px; margin-top: 3px; color: rgba(255,255,255,0.7); }
        .func-btn.voice { background: linear-gradient(135deg, var(--primary), #8338ec); border: none; }

        .remind-section { margin-top: 5px; }
        .remind-title { font-size: 12px; color: var(--gold); margin-bottom: 8px; }
        .remind-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,107,157,0.1); border: 1px solid rgba(255,107,157,0.2); border-radius: 10px; margin-bottom: 6px; cursor: pointer; }
        .remind-item .emoji { font-size: 20px; }
        .remind-item .info { flex: 1; }
        .remind-item .title { font-size: 12px; font-weight: 500; }
        .remind-item .datetime { font-size: 10px; color: var(--gold); margin-top: 2px; font-family: monospace; }
        .remind-item .countdown { font-size: 10px; color: var(--success); font-weight: bold; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,25,47,0.98); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 6px 0 10px; z-index: 100; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px 8px; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn .icon { font-size: 18px; }
        .nav-btn .label { font-size: 8px; margin-top: 2px; }

        .panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 199; display: none; }
        .panel-overlay.show { display: block; }
        .panel { position: fixed; top: 0; right: -100%; width: 92%; max-width: 380px; height: 100%; background: linear-gradient(180deg, rgba(10,25,47,0.98), rgba(17,34,64,0.98)); z-index: 200; transition: right 0.3s; overflow-y: auto; padding: 50px 15px 30px; }
        .panel.open { right: 0; }
        .panel-close { position: absolute; top: 12px; right: 15px; background: none; border: none; color: white; font-size: 26px; cursor: pointer; }
        .panel-title { font-size: 16px; color: var(--gold); margin-bottom: 15px; }

        .item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 6px; cursor: pointer; }
        .item:active { background: rgba(255,255,255,0.1); }
        .item .icon { font-size: 18px; }
        .item .info { flex: 1; }
        .item .name { font-size: 12px; }
        .item .desc { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .section-title { font-size: 12px; color: var(--gold); margin: 15px 0 8px; }
        .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 0; }
        .form-group { margin-bottom: 8px; }
        .form-group label { display: block; font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 3px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 12px; }
        .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 12px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #8338ec); color: white; }
        .btn-gold { background: linear-gradient(135deg, var(--gold), #ff8c00); color: #000; }
        .btn-outline { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: var(--accent); color: white; }

        .datetime-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }
        .datetime-input { text-align: center; }
        .datetime-input label { font-size: 9px; display: block; margin-bottom: 2px; }
        .datetime-input input { text-align: center; padding: 6px 4px; font-size: 14px; font-weight: bold; }

        .detail-time-box { background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 12px; }
        .detail-time-big { font-size: 20px; font-weight: bold; color: var(--gold); font-family: monospace; line-height: 1.5; }
        .detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; }

        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .theme-item { aspect-ratio: 1; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .theme-item.active { border-color: white; }
        .theme-item.classic { background: linear-gradient(135deg, #00d4ff, #8338ec); }
        .theme-item.luxury { background: linear-gradient(135deg, #ffd700, #ff8c00); }
        .theme-item.nature { background: linear-gradient(135deg, #06ffa5, #00d4ff); }
        .theme-item.romantic { background: linear-gradient(135deg, #ff6b9d, #8338ec); }

        .sound-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-size: 11px; }
        .sound-item.active { border-color: var(--gold); background: rgba(255,215,0,0.1); }

        .ad-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
        .ad-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .ad-card .type-badge { font-size: 9px; padding: 2px 6px; border-radius: 8px; }
        .ad-card .type-badge.text { background: #667eea; }
        .ad-card .type-badge.image { background: #06ffa5; color: #000; }
        .ad-card .type-badge.video { background: #ff006e; }
        .ad-card .type-badge.link { background: #ffd700; color: #000; }
        .ad-card .preview { font-size: 11px; color: rgba(255,255,255,0.7); word-break: break-all; }
        .ad-card .preview img { max-width: 100%; max-height: 60px; border-radius: 6px; margin-top: 4px; }

        .contact-auth-box { background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(131,56,236,0.1)); border: 1px solid rgba(0,212,255,0.3); border-radius: 14px; padding: 18px; text-align: center; margin-bottom: 12px; }
        .contact-auth-box .icon { font-size: 36px; margin-bottom: 8px; }
        .contact-auth-box .title { font-size: 13px; font-weight: bold; margin-bottom: 6px; }
        .contact-auth-box .desc { font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 12px; line-height: 1.5; }

        .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 6px; }
        .contact-item .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .contact-item .info { flex: 1; }
        .contact-item .name { font-size: 12px; font-weight: 500; }
        .contact-item .phone { font-size: 9px; color: rgba(255,255,255,0.5); }
        .contact-item .add-btn { padding: 5px 10px; background: var(--gold); border: none; border-radius: 12px; color: #000; font-size: 9px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .contact-item .add-btn:disabled { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); cursor: default; }
        .contact-item.added .add-btn { background: rgba(6,255,165,0.3); color: var(--success); }

        /* ç®¡ç†å‘˜ç™»å½•æ¡† */
        .admin-login-box { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .admin-login-box .title { font-size: 12px; color: var(--accent); margin-bottom: 10px; text-align: center; }
        .admin-locked { text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-size: 11px; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.92); z-index: 300; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-box { background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid var(--primary); border-radius: 16px; padding: 20px; max-width: 340px; width: 100%; max-height: 85vh; overflow-y: auto; }
        .modal-title { font-size: 14px; color: var(--gold); margin-bottom: 12px; text-align: center; }
        .toast { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); border: 1px solid var(--primary); padding: 10px 20px; border-radius: 20px; z-index: 1000; font-size: 12px; }

        /* æ°´å­¦é¢æ¿æ ·å¼ */
        .water-tabs { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 4px; }
        .water-tab { padding: 6px 12px; background: rgba(0,0,0,0.2); border: 1px solid transparent; border-radius: 20px; font-size: 11px; color: rgba(255,255,255,0.7); cursor: pointer; white-space: nowrap; }
        .water-tab.active { background: rgba(0,188,212,0.3); border-color: var(--water); color: var(--water); }
        .water-lesson { background: rgba(0,188,212,0.08); border: 1px solid rgba(0,188,212,0.2); border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        .water-lesson .title { font-size: 13px; color: var(--gold); margin-bottom: 6px; font-weight: bold; }
        .water-lesson .text { font-size: 12px; line-height: 1.8; color: rgba(255,255,255,0.85); }
        .water-lesson .source { font-size: 9px; color: rgba(255,255,255,0.4); text-align: right; margin-top: 6px; }
        .water-controls { display: flex; gap: 6px; margin-bottom: 14px; }
        .water-controls button { flex: 1; padding: 8px; background: rgba(0,188,212,0.15); border: 1px solid rgba(0,188,212,0.3); border-radius: 8px; color: var(--water); font-size: 11px; cursor: pointer; }

        /* è‹æ ¼æ‹‰åº•å¯¹è¯ */
        .socratic-box { background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(0,188,212,0.08)); border: 2px solid rgba(255,215,0,0.3); border-radius: 14px; padding: 15px; margin-top: 10px; }
        .socratic-title { font-size: 13px; color: var(--gold); font-weight: bold; margin-bottom: 10px; }
        .socratic-chat { max-height: 300px; overflow-y: auto; margin-bottom: 10px; }
        .chat-bubble { padding: 10px 12px; border-radius: 12px; margin-bottom: 8px; font-size: 12px; line-height: 1.7; animation: fadeIn 0.3s; }
        .chat-bubble.master { background: rgba(0,188,212,0.15); border-left: 3px solid var(--water); margin-right: 30px; }
        .chat-bubble.student { background: rgba(255,215,0,0.1); border-right: 3px solid var(--gold); margin-left: 30px; text-align: right; }
        .chat-bubble .role { font-size: 9px; color: var(--gold); margin-bottom: 4px; font-weight: bold; }
        .socratic-options { display: flex; flex-direction: column; gap: 6px; }
        .socratic-opt { padding: 10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; font-size: 11px; cursor: pointer; text-align: left; transition: all 0.2s; }
        .socratic-opt:hover { background: rgba(0,188,212,0.2); border-color: var(--water); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* è¯­éŸ³æµ®çƒ */
        .voice-fab { position: fixed; bottom: 80px; right: 15px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #8338ec); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 200; cursor: pointer; box-shadow: 0 4px 20px rgba(0,212,255,0.4); transition: all 0.3s; }
        .voice-fab.listening { animation: voicePulse 1s infinite; background: linear-gradient(135deg, #ff006e, #ff4444); box-shadow: 0 4px 30px rgba(255,0,110,0.6); }
        .voice-fab .voice-label { position: absolute; bottom: -20px; font-size: 9px; white-space: nowrap; color: rgba(255,255,255,0.7); }
        @keyframes voicePulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        .voice-status { position: fixed; bottom: 145px; right: 8px; background: rgba(0,0,0,0.9); border: 1px solid var(--primary); border-radius: 12px; padding: 8px 12px; font-size: 10px; max-width: 180px; z-index: 200; display: none; }
        .voice-status.show { display: block; }

        /* ğŸ’§ å–æ°´æé†’æ ¸å¿ƒåŠŸèƒ½ */
        .water-remind-box { background: linear-gradient(135deg, rgba(0,188,212,0.15), rgba(0,150,200,0.1)); border: 2px solid rgba(0,188,212,0.4); border-radius: 16px; padding: 15px; margin: 12px 0; }
        .water-remind-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .water-title { font-size: 14px; font-weight: bold; color: var(--water); }
        .water-goal { font-size: 11px; color: rgba(255,255,255,0.6); }
        .water-progress-bar { height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .water-progress-fill { height: 100%; background: linear-gradient(90deg, #00bcd4, #00e5ff, #4dd0e1); border-radius: 6px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(0,188,212,0.5); }
        .water-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .water-current { font-size: 24px; font-weight: bold; color: white; }
        .water-current span { color: var(--water); }
        .water-percent { font-size: 16px; color: var(--gold); font-weight: bold; }
        .water-buttons { display: flex; gap: 8px; margin-bottom: 12px; }
        .water-btn { border: none; border-radius: 20px; padding: 8px 12px; font-size: 11px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .water-btn.small { background: rgba(255,255,255,0.1); color: white; flex: 1; }
        .water-btn.small:active { background: rgba(0,188,212,0.3); }
        .water-btn.primary { background: linear-gradient(135deg, #00bcd4, #0097a7); color: white; flex: 2; }
        .water-btn.primary:active { transform: scale(0.95); }
        .water-schedule { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .schedule-item { font-size: 9px; padding: 4px 8px; background: rgba(255,255,255,0.08); border-radius: 12px; color: rgba(255,255,255,0.5); }
        .schedule-item.done { background: rgba(6,255,165,0.2); color: var(--success); }
        .schedule-item.active { background: rgba(0,188,212,0.3); color: var(--water); animation: pulse 1.5s infinite; border: 1px solid var(--water); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* ä¼šå‘˜ä½“ç³»æ ·å¼ */
        .membership-box { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.1)); border: 2px solid rgba(255,215,0,0.3); border-radius: 16px; padding: 15px; margin: 10px 0; }
        .membership-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .membership-level { font-size: 14px; font-weight: bold; }
        .membership-level.free { color: rgba(255,255,255,0.6); }
        .membership-level.vip { color: var(--gold); }
        .membership-level.enterprise { color: #ff6b6b; }
        .membership-limits { font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 12px; line-height: 1.6; }
        .membership-plans { display: flex; flex-direction: column; gap: 8px; }
        .plan-btn { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .plan-btn:hover { background: rgba(255,215,0,0.1); border-color: var(--gold); }
        .plan-btn .plan-name { font-size: 12px; font-weight: bold; }
        .plan-btn .plan-price { font-size: 14px; color: var(--gold); font-weight: bold; }
        .plan-btn.recommended { background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,140,0,0.15)); border-color: var(--gold); }
        .plan-btn.recommended::after { content: 'æ¨è'; font-size: 9px; background: var(--gold); color: #000; padding: 2px 6px; border-radius: 8px; margin-left: 8px; }

        /* PWA å®‰è£…æç¤ºæ ·å¼ */
        .pwa-banner { display: none; position: fixed; bottom: 55px; left: 8px; right: 8px; background: linear-gradient(135deg, var(--primary), #8338ec); padding: 12px; border-radius: 12px; z-index: 150; box-shadow: 0 4px 20px rgba(0,212,255,0.4); animation: pwaSlide 0.4s ease; }
        .pwa-banner.show { display: block; }
        @keyframes pwaSlide { from { transform: translateY(80px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pwa-banner-inner { display: flex; align-items: center; gap: 10px; }
        .pwa-banner-icon { font-size: 28px; }
        .pwa-banner-text { flex: 1; }
        .pwa-banner-title { font-size: 12px; font-weight: bold; }
        .pwa-banner-desc { font-size: 10px; opacity: 0.85; margin-top: 2px; }
        .pwa-banner-btn { background: white; color: #8338ec; border: none; padding: 8px 14px; border-radius: 16px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .pwa-banner-close { position: absolute; top: 4px; right: 8px; background: none; border: none; color: white; font-size: 16px; cursor: pointer; opacity: 0.7; }
        .pwa-guide { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 400; justify-content: center; align-items: center; padding: 15px; }
        .pwa-guide.show { display: flex; }
        .pwa-guide-box { background: linear-gradient(135deg, var(--bg1), var(--bg2)); border: 2px solid var(--primary); border-radius: 16px; padding: 20px; max-width: 320px; width: 100%; }
        .pwa-guide-header { text-align: center; margin-bottom: 15px; }
        .pwa-guide-header .icon { font-size: 40px; }
        .pwa-guide-header .title { font-size: 16px; font-weight: bold; color: var(--gold); margin-top: 8px; }
        .pwa-guide-header .desc { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        .pwa-guide-steps { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px; }
        .pwa-guide-step { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; line-height: 1.5; }
        .pwa-guide-step:last-child { border-bottom: none; }
        .pwa-step-num { background: var(--primary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; flex-shrink: 0; }
        .pwa-guide-btn { width: 100%; padding: 10px; background: linear-gradient(135deg, var(--primary), #8338ec); border: none; border-radius: 20px; color: white; font-size: 13px; font-weight: bold; cursor: pointer; }
        .pwa-wechat-tip { background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.4); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 10px; color: var(--gold); line-height: 1.5; display: none; }
    </style>
</head>
<body>
    <!-- PWA å®‰è£…æç¤º -->
    <div class="pwa-banner" id="pwaBanner">
        <button class="pwa-banner-close" onclick="closePwaBanner()">Ã—</button>
        <div class="pwa-banner-inner">
            <div class="pwa-banner-icon">ğŸ’§</div>
            <div class="pwa-banner-text">
                <div class="pwa-banner-title">æ·»åŠ åˆ°æ¡Œé¢</div>
                <div class="pwa-banner-desc">åƒAPPä¸€æ ·ä½¿ç”¨ï¼Œä¸€é”®æ‰“å¼€</div>
            </div>
            <button class="pwa-banner-btn" onclick="handlePwaInstall()">æ·»åŠ </button>
        </div>
    </div>
    <div class="pwa-guide" id="pwaGuide">
        <div class="pwa-guide-box">
            <div class="pwa-guide-header">
                <div class="icon">ğŸ“±</div>
                <div class="title">æ·»åŠ åˆ°ä¸»å±å¹•</div>
                <div class="desc">3æ­¥å®Œæˆï¼ŒåƒAPPä¸€æ ·ä½¿ç”¨</div>
            </div>
            <div class="pwa-wechat-tip" id="pwaWechatTip">âš ï¸ å½“å‰åœ¨å¾®ä¿¡å†…ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ Â·Â·Â· é€‰æ‹©ã€Œåœ¨æµè§ˆå™¨æ‰“å¼€ã€</div>
            <div class="pwa-guide-steps" id="pwaSteps"></div>
            <button class="pwa-guide-btn" onclick="closePwaGuide()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="logo">ğŸ’§ <span data-i18n="appName">å–æ°´äº†å—</span></div>
        <div class="top-right">
            <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
            <button class="top-btn" onclick="openPanel('promoPanel')" data-i18n="promo">æ¨å¹¿</button>
            <button class="top-btn" id="userBtn" onclick="openPanel('memberPanel')" data-i18n="login">ç™»å½•</button>
        </div>
    </div>

    <div class="ad-bar"><div class="ad-container" id="adContainer"></div></div>

    <div class="main">
        <div class="culture-card">
            <div class="culture-bg" id="cultureBg"></div>
            <div class="culture-content">
                <div class="culture-label">ğŸ’§ <span data-i18n="dailyWisdom">æ¯æ—¥æ°´è¯­</span> Â· <span id="cultureDate"></span></div>
                <div class="culture-text" id="cultureText"></div>
                <div class="culture-source" id="cultureSource"></div>
                <div class="culture-actions">
                    <button class="culture-btn" onclick="copyCulture()" data-i18n="copy">å¤åˆ¶</button>
                    <button class="culture-btn" onclick="refreshCulture()" data-i18n="refresh">æ¢ä¸€æ¡</button>
                </div>
            </div>
        </div>

        <div class="checkin-bar">
            <div class="checkin-info">
                <div class="checkin-streak"><span data-i18n="streak">è¿ç»­</span> <strong id="streakDays">0</strong> <span data-i18n="days">å¤©</span></div>
                <div class="checkin-points"><span data-i18n="points">ç§¯åˆ†</span>: <span id="totalPoints">0</span></div>
            </div>
            <button class="checkin-btn" id="checkinBtn" onclick="doCheckin()">âœ… <span data-i18n="checkin">æ‰“å¡</span>+10</button>
        </div>

        <div class="clock-unit">
            <div class="clock-area">
                <div class="clock-face" id="clockFace">
                    <div id="ticks"></div>
                    <div class="clock-num n12">12</div>
                    <div class="clock-num n3">3</div>
                    <div class="clock-num n6">6</div>
                    <div class="clock-num n9">9</div>
                    <div class="clock-center" onclick="openPanel('centerPanel')">
                        <div class="center-content" id="centerContent">
                            <div class="center-placeholder" data-i18n="clickToAdd">ç‚¹å‡»æ·»åŠ <br>å›¾ç‰‡/è§†é¢‘/æ–‡å­—</div>
                        </div>
                    </div>
                    <div class="hand hand-hour" id="hHour"></div>
                    <div class="hand hand-minute" id="hMin"></div>
                    <div class="hand hand-second" id="hSec"></div>
                    <div class="hand-dot"></div>
                </div>

                <div class="digital-box">
                    <div class="digital-time">
                        <span id="dH">00</span><span class="colon">:</span><span id="dM">00</span><span class="colon">:</span><span id="dS">00</span>
                    </div>
                    <div class="digital-date" id="digitalDate"></div>
                    <div class="slogan" data-i18n="slogan">ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€</div>
                </div>

                <div class="tick-bar" onclick="openPanel('settingsPanel')">
                    <div class="tick-dot" id="tickDot"></div>
                    <span style="font-size:11px;" data-i18n="tickSound">æ»´ç­”å£°</span>
                    <span style="font-size:10px;color:var(--gold);" id="tickSoundName">ç»å…¸é’Ÿå£°</span>
                </div>

                <!-- ğŸ’§ å–æ°´æé†’æ ¸å¿ƒåŠŸèƒ½åŒº -->
                <div class="water-remind-box">
                    <div class="water-remind-header">
                        <span class="water-title">ğŸ’§ ä»Šæ—¥é¥®æ°´</span>
                        <span class="water-goal" id="waterGoalText">ç›®æ ‡ 2000ml</span>
                    </div>
                    <div class="water-progress-bar">
                        <div class="water-progress-fill" id="waterProgressFill" style="width:0%"></div>
                    </div>
                    <div class="water-stats">
                        <span class="water-current"><span id="waterCurrent">0</span> ml</span>
                        <span class="water-percent" id="waterPercent">0%</span>
                    </div>
                    <div class="water-buttons">
                        <button class="water-btn small" onclick="drinkWater(100)">+100ml</button>
                        <button class="water-btn small" onclick="drinkWater(200)">+200ml</button>
                        <button class="water-btn primary" onclick="drinkWater(250)">ğŸ¥¤ å–ä¸€æ¯ 250ml</button>
                    </div>
                    <div class="water-schedule" id="waterSchedule">
                        <span class="schedule-item done">â˜€ï¸ 7:00</span>
                        <span class="schedule-item done">ğŸŒ¤ï¸ 9:00</span>
                        <span class="schedule-item active">â˜€ï¸ 11:00</span>
                        <span class="schedule-item">ğŸš 13:00</span>
                        <span class="schedule-item">ğŸŒ¤ï¸ 15:00</span>
                        <span class="schedule-item">ğŸŒ… 17:00</span>
                        <span class="schedule-item">ğŸŒ™ 19:00</span>
                        <span class="schedule-item">ğŸ˜´ 21:00</span>
                    </div>
                </div>

                <div class="func-row">
                    <div class="func-btn" onclick="openPanel('classicsPanel')"><div class="icon">ğŸ“–</div><div class="label" data-i18n="classics">ç»å…¸</div></div>
                    <div class="func-btn" onclick="openPanel('waterPanel')"><div class="icon">ğŸ’§</div><div class="label" data-i18n="waterStudy">æ°´å­¦</div></div>
                    <div class="func-btn voice" onclick="toggleVoice()"><div class="icon">ğŸ¤</div><div class="label" data-i18n="voice">è¯­éŸ³</div></div>
                    <div class="func-btn" onclick="openPanel('carePanel')"><div class="icon">ğŸ’</div><div class="label" data-i18n="care">å…³æ€€</div></div>
                    <div class="func-btn" onclick="openPanel('settingsPanel')"><div class="icon">âš™ï¸</div><div class="label" data-i18n="settings">è®¾ç½®</div></div>
                </div>
            </div>

            <div class="remind-section">
                <div class="remind-title">ğŸ”” <span data-i18n="upcomingReminders">å³å°†åˆ°æ¥çš„æé†’</span></div>
                <div id="upcomingReminds"></div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="nav-btn active"><span class="icon">ğŸ </span><span class="label" data-i18n="home">é¦–é¡µ</span></button>
        <button class="nav-btn" onclick="openPanel('promoPanel')"><span class="icon">ğŸ“£</span><span class="label" data-i18n="promo">æ¨å¹¿</span></button>
        <button class="nav-btn" onclick="openPanel('settingsPanel')"><span class="icon">â°</span><span class="label" data-i18n="remind">æé†’</span></button>
        <button class="nav-btn" onclick="openPanel('pointsPanel')"><span class="icon">ğŸ</span><span class="label" data-i18n="points">ç§¯åˆ†</span></button>
        <button class="nav-btn" onclick="openPanel('memberPanel')"><span class="icon">ğŸ‘¤</span><span class="label" data-i18n="me">æˆ‘çš„</span></button>
    </div>

    <!-- è¯­éŸ³æµ®çƒã€Œæ™ºå›ã€ -->
    <div class="voice-fab" id="voiceFab" onclick="toggleVoiceRecognition()">
        ğŸ¤
        <div class="voice-label">è¯´ã€Œæ™ºå›ã€</div>
    </div>
    <div class="voice-status" id="voiceStatus">ğŸ¤ ç­‰å¾…å”¤é†’è¯ã€Œæ™ºå›ã€...</div>

    <div class="panel-overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="panel" id="settingsPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">âš™ï¸ <span data-i18n="settings">è®¾ç½®</span></div>

        <div class="section-title">â° <span data-i18n="reminderManagement">æé†’ç®¡ç†</span></div>
        <button class="btn btn-gold" style="margin-bottom:10px;" onclick="openModal('addRemindModal')">â• <span data-i18n="newReminder">æ–°å»ºæé†’</span></button>
        <div id="remindList"></div>

        <div class="divider"></div>

        <div class="section-title">ğŸ”Š <span data-i18n="soundSettings">æ»´ç­”å£°è®¾ç½®</span></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:10px;">
            <span style="font-size:12px;" data-i18n="tickSwitch">æ»´ç­”å£°å¼€å…³</span>
            <div style="width:44px;height:24px;background:rgba(255,255,255,0.2);border-radius:12px;position:relative;cursor:pointer;" id="tickSwitch" onclick="toggleTick()">
                <div style="width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;transition:0.3s;" id="tickKnob"></div>
            </div>
        </div>
        <div id="soundList"></div>
        <div class="section-title">ğŸ”ˆ <span data-i18n="volume">éŸ³é‡</span></div>
        <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width:100%;" onchange="setVolume(this.value)">

        <div class="divider"></div>

        <div class="section-title">ğŸ¨ <span data-i18n="theme">ä¸»é¢˜é£æ ¼</span></div>
        <div class="theme-grid">
            <div class="theme-item classic active" onclick="setTheme('classic')"></div>
            <div class="theme-item luxury" onclick="setTheme('luxury')"></div>
            <div class="theme-item nature" onclick="setTheme('nature')"></div>
            <div class="theme-item romantic" onclick="setTheme('romantic')"></div>
        </div>

        <div class="divider"></div>

        <!-- ç®¡ç†å‘˜å¹¿å‘Šè®¾ç½® -->
        <div class="section-title">ğŸ“¢ <span data-i18n="adManagement">å¹¿å‘Šç®¡ç†</span> <span style="font-size:9px;color:var(--accent);">(ç®¡ç†å‘˜)</span></div>
        
        <div id="adminAdSection">
            <div class="admin-login-box" id="adminLoginBox">
                <div class="title">ğŸ” <span data-i18n="adminLogin">ç®¡ç†å‘˜ç™»å½•</span></div>
                <div class="form-group">
                    <input type="password" id="adminPwd" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                </div>
                <button class="btn btn-danger" onclick="adminLogin()" data-i18n="verify">éªŒè¯</button>
            </div>
            
            <div id="adminAdContent" style="display:none;">
                <div id="adList"></div>
                <button class="btn btn-outline" style="margin-bottom:8px;" onclick="openModal('addAdModal')">â• <span data-i18n="addAd">æ·»åŠ æ–°å¹¿å‘Š</span></button>
                <button class="btn btn-outline" onclick="adminLogout()" style="font-size:10px;" data-i18n="adminLogout">é€€å‡ºç®¡ç†</button>
            </div>
        </div>
    </div>

    <!-- é’Ÿè¡¨ä¸­å¿ƒé¢æ¿ -->
    <div class="panel" id="centerPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ¨ <span data-i18n="customizeCenter">è‡ªå®šä¹‰é’Ÿè¡¨ä¸­å¿ƒ</span></div>
        
        <div class="section-title">ğŸ“· <span data-i18n="uploadImage">ä¸Šä¼ å›¾ç‰‡</span></div>
        <div style="border:2px dashed rgba(255,255,255,0.2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-bottom:12px;" onclick="document.getElementById('imgUpload').click()">
            <div style="font-size:28px;">ğŸ–¼ï¸</div>
            <div style="font-size:10px;color:rgba(255,255,255,0.5);" data-i18n="clickUpload">ç‚¹å‡»ä¸Šä¼ </div>
        </div>
        <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="uploadImage(this)">

        <div class="section-title">ğŸ¬ <span data-i18n="uploadVideo">ä¸Šä¼ è§†é¢‘</span></div>
        <div style="border:2px dashed rgba(255,255,255,0.2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-bottom:12px;" onclick="document.getElementById('vidUpload').click()">
            <div style="font-size:28px;">ğŸ¬</div>
            <div style="font-size:10px;color:rgba(255,255,255,0.5);" data-i18n="clickUpload">ç‚¹å‡»ä¸Šä¼ </div>
        </div>
        <input type="file" id="vidUpload" accept="video/*" style="display:none" onchange="uploadVideo(this)">

        <div class="section-title">âœï¸ <span data-i18n="customText">è‡ªå®šä¹‰æ–‡å­—</span></div>
        <div class="form-group"><textarea id="centerText" rows="3" placeholder="è¾“å…¥æ–‡å­—..."></textarea></div>
        <button class="btn btn-primary" onclick="setCenterText()" data-i18n="apply">åº”ç”¨</button>
        <div class="divider"></div>
        <button class="btn btn-outline" onclick="resetCenter()" data-i18n="resetDefault">æ¢å¤é»˜è®¤</button>
    </div>

    <!-- å…³æ€€é¢æ¿ -->
    <div class="panel" id="carePanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ’ <span data-i18n="smartCare">æ™ºèƒ½å…³æ€€</span></div>

        <!-- æœªæˆæƒæ—¶æ˜¾ç¤º -->
        <div class="contact-auth-box" id="contactAuthBox">
            <div class="icon">ğŸ“±</div>
            <div class="title" data-i18n="readContacts">è¯»å–é€šè®¯å½•</div>
            <div class="desc" data-i18n="contactsDesc">æˆæƒåå¯å¿«é€ŸæŸ¥æ‰¾å¹¶æ·»åŠ è¢«å…³æ€€äººï¼Œè®¾ç½®ç”Ÿæ—¥ã€çºªå¿µæ—¥ç­‰å…³æ€€æé†’ã€‚</div>
            <button class="btn btn-gold" onclick="requestContactsPermission()">ğŸ“‡ <span data-i18n="authorizeContacts">æˆæƒè¯»å–é€šè®¯å½•</span></button>
        </div>

        <!-- å·²æˆæƒåæ˜¾ç¤ºæœç´¢æ¡†+é€šè®¯å½•åˆ—è¡¨ -->
        <div id="contactSearchBox" style="display:none;">
            <div class="section-title">ğŸ” <span data-i18n="findCarePerson">æŸ¥æ‰¾è¢«å…³æ€€äºº</span></div>
            <div style="position:relative;margin-bottom:12px;">
                <input type="text" id="careSearchInput" placeholder="è¾“å…¥å§“åæŸ¥æ‰¾..." oninput="searchCarePerson(this.value)" style="width:100%;padding:12px 15px;padding-left:40px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:12px;color:white;font-size:14px;">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:18px;">ğŸ”</span>
            </div>
            <!-- æœç´¢ç»“æœ -->
            <div id="searchResults" style="max-height:200px;overflow-y:auto;"></div>

            <!-- é€šè®¯å½•å®Œæ•´åˆ—è¡¨ -->
            <div id="contactsDirectory">
                <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 8px;">
                    <span style="font-size:12px;color:var(--water);font-weight:bold;">ğŸ“‡ é€šè®¯å½• (<span id="contactCount">0</span>äºº)</span>
                    <div>
                        <button onclick="refreshContacts()" style="background:none;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:3px 8px;font-size:9px;color:rgba(255,255,255,0.6);cursor:pointer;margin-right:4px;">ğŸ”„ åˆ·æ–°</button>
                        <button onclick="resetContactsAuth()" style="background:none;border:1px solid rgba(255,100,100,0.3);border-radius:8px;padding:3px 8px;font-size:9px;color:rgba(255,100,100,0.6);cursor:pointer;">ğŸ—‘ï¸ é‡ç½®</button>
                    </div>
                </div>
                <div id="contactsList" style="max-height:320px;overflow-y:auto;"></div>
            </div>
        </div>

        <div class="divider"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <span class="section-title" style="margin:0">ğŸ‘¥ <span data-i18n="addedFriends">å·²æ·»åŠ çš„å…³æ€€å¯¹è±¡</span></span>
            <button class="btn btn-primary" style="width:auto;padding:5px 10px;font-size:10px;" onclick="openModal('addFriendModal')">+ <span data-i18n="manualAdd">æ‰‹åŠ¨æ·»åŠ </span></button>
        </div>
        <div id="friendList"></div>
    </div>

    <!-- ç»å…¸é¢æ¿ï¼ˆåŸç»ä¹¦ï¼Œå¸¦äºŒçº§ç›®å½•ï¼‰ -->
    <div class="panel" id="classicsPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ“– <span data-i18n="classics">ç»å…¸</span></div>

        <div class="water-tabs" id="classicsTabs">
            <div class="water-tab active" onclick="switchClassicsTab('scriptures')">ğŸ“œ äº”ç»</div>
            <div class="water-tab" onclick="switchClassicsTab('philosophy')">ğŸ“ å“²å­¦</div>
            <div class="water-tab" onclick="switchClassicsTab('poetry')">ğŸ“ è¯—è¯</div>
            <div class="water-tab" onclick="switchClassicsTab('wisdom')">ğŸ’¡ æ™ºæ…§</div>
        </div>

        <div id="classicsContent"></div>
    </div>

    <div class="panel" id="waterPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ’§ <span data-i18n="waterCourse">æ°´å­¦è¯¾ç¨‹</span></div>

        <div class="water-tabs" id="waterTabs">
            <div class="water-tab active" onclick="switchWaterTab('science')">ğŸ”¬ æ°´ç§‘å­¦</div>
            <div class="water-tab" onclick="switchWaterTab('philosophy')">â˜¯ï¸ æ°´å“²å­¦</div>
            <div class="water-tab" onclick="switchWaterTab('health')">ğŸ’Š æ°´å¥åº·</div>
            <div class="water-tab" onclick="switchWaterTab('socratic')">ğŸ›ï¸ æ°´é—®ç­”</div>
        </div>

        <!-- æ°´å­¦äºŒçº§ç›®å½• -->
        <div class="water-submenu" style="display:flex;flex-wrap:wrap;gap:6px;margin:10px 0;padding:10px;background:rgba(0,188,212,0.08);border-radius:12px;">
            <div class="submenu-item" onclick="openWaterSection('institute')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ›ï¸</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´å­¦ç ”ç©¶é™¢</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">å­¦æœ¯ç ”ç©¶</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('tech')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ”§</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´ç§‘æŠ€</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">ç§‘æŠ€åˆ›æ–°</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('products')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ›’</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´äº§å“</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">å¥åº·å¥½ç‰©</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('inventions')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ’¡</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´å‘æ˜</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">ä¸“åˆ©æŠ€æœ¯</div>
            </div>
        </div>
            <div class="water-tab" onclick="switchWaterTab('health')">ğŸ’Š æ°´å¥åº·</div>
            <div class="water-tab" onclick="switchWaterTab('socratic')">ğŸ›ï¸ æ°´é—®ç­”</div>
        </div>

        <div id="waterLessonContent"></div>

        <div class="water-controls">
            <button onclick="prevWaterLesson()">â¬… ä¸Šä¸€è¯¾</button>
            <button onclick="speakWaterLesson()">ğŸ”Š æœ—è¯»</button>
            <button onclick="nextWaterLesson()">ä¸‹ä¸€è¯¾ â¡</button>
        </div>

        <div id="socraticSection" style="display:none;">
            <div class="socratic-box">
                <div class="socratic-title">ğŸ›ï¸ æ°´çš„è‹æ ¼æ‹‰åº•å¯¹è¯</div>
                <div class="socratic-chat" id="socraticChat"></div>
                <div class="socratic-options" id="socraticOptions"></div>
            </div>
        </div>

        <div id="waterList" style="display:none;"></div>
    </div>

    <div class="panel" id="promoPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ“£ <span data-i18n="promoCenter">æ¨å¹¿ä¸­å¿ƒ</span></div>
        <div style="text-align:center;padding:20px;background:rgba(255,215,0,0.08);border-radius:14px;">
            <div style="font-size:12px;" data-i18n="myInviteCode">æˆ‘çš„é‚€è¯·ç </div>
            <div style="font-size:20px;font-weight:bold;color:var(--gold);margin:10px 0;" id="inviteCode">--</div>
            <div id="promoQR" style="background:white;padding:10px;border-radius:10px;display:inline-block;margin:10px 0;"></div>
        </div>
        <button class="btn btn-gold" style="margin-top:15px;" onclick="copyInviteLink()" data-i18n="copyInviteLink">å¤åˆ¶é‚€è¯·é“¾æ¥</button>
    </div>

    <div class="panel" id="pointsPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ <span data-i18n="pointsCenter">ç§¯åˆ†ä¸­å¿ƒ</span></div>
        <div style="text-align:center;padding:20px;background:rgba(255,215,0,0.08);border-radius:14px;margin-bottom:15px;">
            <div style="font-size:10px;color:rgba(255,255,255,0.6);" data-i18n="myPoints">æˆ‘çš„ç§¯åˆ†</div>
            <div style="font-size:32px;font-weight:bold;color:var(--gold);" id="myPoints">0</div>
        </div>
        <div class="section-title">ğŸ“… <span data-i18n="monthlyCheckin">æœ¬æœˆæ‰“å¡</span></div>
        <div id="checkinCalendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;"></div>
    </div>

    <div class="panel" id="memberPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div id="loginBox">
            <div class="panel-title">ğŸ” <span data-i18n="loginRegister">ç™»å½• / æ³¨å†Œ</span></div>
            <div class="form-group"><label data-i18n="phone">æ‰‹æœºå·</label><input type="tel" id="phoneInput" placeholder="11ä½æ‰‹æœºå·"></div>
            <div class="form-group"><label data-i18n="nickname">æ˜µç§°</label><input type="text" id="nameInput" placeholder="æ‚¨çš„æ˜µç§°"></div>
            <div class="form-group"><label data-i18n="password">å¯†ç </label><input type="password" id="pwdInput" placeholder="6ä½ä»¥ä¸Šå¯†ç "></div>
            <button class="btn btn-gold" onclick="doLogin()" data-i18n="loginRegister">ç™»å½• / æ³¨å†Œ</button>
        </div>
        <div id="memberBox" style="display:none;">
            <div style="text-align:center;padding:20px;background:rgba(255,215,0,0.08);border-radius:14px;margin-bottom:15px;">
                <div style="font-size:36px;" id="avatar">ğŸ‘¤</div>
                <div style="font-size:16px;font-weight:bold;margin-top:8px;" id="userName">ç”¨æˆ·</div>
                <div style="font-size:11px;color:var(--gold);margin-top:4px;" id="userLevel">å…è´¹ç”¨æˆ·</div>
            </div>

            <!-- ä¼šå‘˜æƒç›Šå¯¹æ¯” -->
            <div class="membership-box">
                <div class="membership-header">
                    <span class="membership-level" id="membershipTitle">ğŸ†“ å…è´¹ç”¨æˆ·</span>
                    <span style="font-size:10px;color:rgba(255,255,255,0.5);">å½“å‰ç­‰çº§</span>
                </div>
                <div class="membership-limits" id="membershipLimits">
                    â€¢ æé†’æ•°é‡ï¼šæ¯å¤©10æ¡<br>
                    â€¢ ç²¾ç¡®åº¦ï¼šåˆ†é’Ÿçº§<br>
                    â€¢ å…³æ€€å¯¹è±¡ï¼š3äºº<br>
                    â€¢ ä¸»é¢˜é£æ ¼ï¼š2æ¬¾<br>
                    â€¢ ç»å…¸/æ°´å­¦ï¼šæ¯æ—¥1ç¯‡<br>
                    â€¢ å¹¿å‘Šï¼šæœ‰å¹¿å‘Š
                </div>
            </div>

            <!-- å‡çº§é€‰é¡¹ -->
            <div style="font-size:12px;font-weight:bold;color:var(--gold);margin:15px 0 10px;">ğŸ‘‘ å‡çº§ä¼šå‘˜</div>
            <div class="membership-plans">
                <div class="plan-btn" onclick="upgradePlan('monthly')">
                    <div>
                        <div class="plan-name">æœˆåº¦ä¼šå‘˜</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">æ— é™æé†’ Â· ç§’çº§ç²¾ç¡®</div>
                    </div>
                    <div class="plan-price">Â¥9.99/æœˆ</div>
                </div>
                <div class="plan-btn" onclick="upgradePlan('quarterly')">
                    <div>
                        <div class="plan-name">å­£åº¦ä¼šå‘˜</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">çœ33% Â· å…¨éƒ¨å†…å®¹</div>
                    </div>
                    <div class="plan-price">Â¥19.99/å­£</div>
                </div>
                <div class="plan-btn recommended" onclick="upgradePlan('yearly')">
                    <div>
                        <div class="plan-name">å¹´åº¦VIP ğŸ”¥</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">çœ83% Â· éŸ³é¢‘è¯¾ç¨‹ Â· æ— å¹¿å‘Š</div>
                    </div>
                    <div class="plan-price">Â¥199/å¹´</div>
                </div>
                <div class="plan-btn" onclick="upgradePlan('enterprise')" style="border-color:rgba(255,107,107,0.5);">
                    <div>
                        <div class="plan-name" style="color:#ff6b6b;">ğŸ¢ ä¼ä¸šç‰ˆ</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">å“ç‰Œå®šåˆ¶ Â· åˆ†ç»„ç®¡ç† Â· ä¸“å±å†…å®¹</div>
                    </div>
                    <div class="plan-price" style="color:#ff6b6b;">Â¥9999/å¹´</div>
                </div>
            </div>

            <button class="btn btn-outline" style="margin-top:15px;" onclick="logout()" data-i18n="logout">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="addRemindModal">
        <div class="modal-box">
            <div class="modal-title">â° <span data-i18n="newReminder">æ–°å»ºæé†’</span></div>
            <div class="form-group"><label data-i18n="title">æ ‡é¢˜</label><input type="text" id="rTitle" placeholder="å¦‚ï¼šåƒè¯ã€å¼€ä¼š"></div>
            <div class="form-group"><label data-i18n="type">ç±»å‹</label>
                <select id="rType">
                    <option value="ğŸ’Š">ğŸ’Š åƒè¯</option>
                    <option value="ğŸ¥">ğŸ¥ å°±åŒ»</option>
                    <option value="ğŸ“…">ğŸ“… å¼€ä¼š</option>
                    <option value="ğŸ‚">ğŸ‚ ç”Ÿæ—¥</option>
                    <option value="ğŸ“">ğŸ“ ç”µè¯</option>
                    <option value="ğŸ””">ğŸ”” å…¶ä»–</option>
                </select>
            </div>
            <div class="section-title">ğŸ“… <span data-i18n="date">æ—¥æœŸ</span></div>
            <div class="datetime-row">
                <div class="datetime-input"><label data-i18n="year">å¹´</label><input type="number" id="rYear"></div>
                <div class="datetime-input"><label data-i18n="month">æœˆ</label><input type="number" id="rMonth" min="1" max="12"></div>
                <div class="datetime-input"><label data-i18n="day">æ—¥</label><input type="number" id="rDay" min="1" max="31"></div>
            </div>
            <div class="section-title">â° <span data-i18n="time">æ—¶é—´</span></div>
            <div class="datetime-row">
                <div class="datetime-input"><label data-i18n="hour">æ—¶</label><input type="number" id="rHour" min="0" max="23"></div>
                <div class="datetime-input"><label data-i18n="minute">åˆ†</label><input type="number" id="rMin" min="0" max="59"></div>
                <div class="datetime-input"><label data-i18n="second">ç§’</label><input type="number" id="rSec" min="0" max="59"></div>
            </div>
            <div class="form-group"><label data-i18n="repeat">é‡å¤</label>
                <select id="rRepeat"><option value="once">ä¸é‡å¤</option><option value="daily">æ¯å¤©</option><option value="weekly">æ¯å‘¨</option><option value="monthly">æ¯æœˆ</option><option value="yearly">æ¯å¹´</option></select>
            </div>
            <div class="form-group"><label data-i18n="note">å¤‡æ³¨</label><textarea id="rNote" rows="2"></textarea></div>
            <button class="btn btn-gold" onclick="addRemind()" data-i18n="save">ä¿å­˜</button>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="closeModal()" data-i18n="cancel">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="modal" id="remindDetailModal">
        <div class="modal-box">
            <div class="modal-title" id="detailTitle">â° æé†’è¯¦æƒ…</div>
            <div id="detailContent"></div>
            <button class="btn btn-primary" onclick="closeModal()" data-i18n="close">å…³é—­</button>
        </div>
    </div>

    <div class="modal" id="addAdModal">
        <div class="modal-box">
            <div class="modal-title">ğŸ“¢ <span data-i18n="addAd">æ·»åŠ å¹¿å‘Š</span></div>
            <div class="form-group"><label data-i18n="adType">å¹¿å‘Šç±»å‹</label>
                <select id="adType" onchange="updateAdForm()">
                    <option value="text">ğŸ“ æ–‡å­—</option>
                    <option value="image">ğŸ–¼ï¸ å›¾ç‰‡</option>
                    <option value="video">ğŸ¬ è§†é¢‘</option>
                    <option value="link">ğŸ”— é“¾æ¥</option>
                </select>
            </div>
            <div id="adFormText"><div class="form-group"><label>æ–‡å­—å†…å®¹</label><textarea id="adText" rows="2"></textarea></div></div>
            <div id="adFormImage" style="display:none;"><div class="form-group"><label>å›¾ç‰‡URL</label><input type="text" id="adImageUrl"></div></div>
            <div id="adFormVideo" style="display:none;"><div class="form-group"><label>è§†é¢‘URL</label><input type="text" id="adVideoUrl"></div></div>
            <div id="adFormLink" style="display:none;">
                <div class="form-group"><label>é“¾æ¥æ ‡é¢˜</label><input type="text" id="adLinkTitle"></div>
                <div class="form-group"><label>é“¾æ¥åœ°å€</label><input type="text" id="adLinkUrl"></div>
            </div>
            <button class="btn btn-gold" onclick="addAd()" data-i18n="add">æ·»åŠ </button>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="closeModal()" data-i18n="cancel">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å…³æ€€æé†’è®¾ç½®å¼¹çª— -->
    <div class="modal" id="careRemindModal">
        <div class="modal-box">
            <div class="modal-title">ğŸ’ è®¾ç½®å…³æ€€æé†’</div>
            
            <div style="text-align:center;padding:15px;background:rgba(0,212,255,0.1);border-radius:12px;margin-bottom:15px;">
                <div style="width:60px;height:60px;border-radius:50%;background:var(--primary);margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;" id="carePersonAvatar">å¼ </div>
                <div style="font-size:16px;font-weight:bold;" id="carePersonName">å¼ ä¸‰</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);" id="carePersonPhone">138****1234</div>
            </div>

            <div class="form-group">
                <label>æé†’ç±»å‹</label>
                <select id="careType" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
                    <option value="ğŸ‚ ç”Ÿæ—¥">ğŸ‚ ç”Ÿæ—¥æé†’</option>
                    <option value="ğŸ’‘ çºªå¿µæ—¥">ğŸ’‘ çºªå¿µæ—¥æé†’</option>
                    <option value="ğŸ’Š åƒè¯">ğŸ’Š åƒè¯æé†’</option>
                    <option value="ğŸ¥ ä½“æ£€">ğŸ¥ ä½“æ£€æé†’</option>
                    <option value="ğŸ“ ç”µè¯">ğŸ“ å®šæœŸç”µè¯</option>
                    <option value="ğŸ  æ¢æœ›">ğŸ  æ¢æœ›æé†’</option>
                    <option value="ğŸ’ å…³æ€€">ğŸ’ å…¶ä»–å…³æ€€</option>
                </select>
            </div>

            <div class="form-group">
                <label>æé†’æ—¥æœŸ</label>
                <div style="display:flex;gap:8px;">
                    <select id="careYear" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careMonth" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careDay" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                </div>
            </div>

            <div class="form-group">
                <label>æé†’æ—¶é—´</label>
                <div style="display:flex;gap:8px;">
                    <select id="careHour" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careMinute" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                </div>
            </div>

            <div class="form-group">
                <label>é‡å¤</label>
                <select id="careRepeat" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
                    <option value="none">ä¸é‡å¤</option>
                    <option value="yearly" selected>æ¯å¹´é‡å¤</option>
                    <option value="monthly">æ¯æœˆé‡å¤</option>
                    <option value="weekly">æ¯å‘¨é‡å¤</option>
                    <option value="daily">æ¯å¤©é‡å¤</option>
                </select>
            </div>

            <div class="form-group">
                <label>å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
                <input type="text" id="careNote" placeholder="å¦‚ï¼šè®°å¾—ä¹°è›‹ç³•" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
            </div>

            <div style="display:flex;gap:10px;margin-top:15px;">
                <button class="btn btn-outline" onclick="closeModal()" style="flex:1;">å–æ¶ˆ</button>
                <button class="btn btn-gold" onclick="saveCareRemind()" style="flex:1;">âœ… ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div class="modal" id="addFriendModal">
        <div class="modal-box">
            <div class="modal-title">ğŸ‘¤ <span data-i18n="addFriend">æ·»åŠ å¥½å‹</span></div>
            <div class="form-group"><label data-i18n="name">å§“å</label><input type="text" id="fName"></div>
            <div class="form-group"><label data-i18n="phone">æ‰‹æœºå·</label><input type="tel" id="fPhone"></div>
            <div class="form-group"><label data-i18n="relation">å…³ç³»</label><select id="fRelation"><option>å®¶äºº</option><option>æœ‹å‹</option><option>åŒäº‹</option></select></div>
            <button class="btn btn-primary" onclick="addFriend()" data-i18n="save">ä¿å­˜</button>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="closeModal()" data-i18n="cancel">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
    // ==================== PWA å®‰è£…é€»è¾‘ ====================
    let pwaPrompt = null;
    const pwaInfo = {
        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
        isAndroid: /Android/.test(navigator.userAgent),
        isWechat: /MicroMessenger/.test(navigator.userAgent),
        isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone
    };

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); pwaPrompt = e; if (!pwaInfo.isStandalone && !localStorage.getItem('pwaDismissed')) setTimeout(showPwaBanner, 5000); });
    window.addEventListener('appinstalled', () => { closePwaBanner(); toast('ğŸ‰ å·²æ·»åŠ åˆ°æ¡Œé¢ï¼'); });

    function showPwaBanner() { if (pwaInfo.isStandalone) return; document.getElementById('pwaBanner').classList.add('show'); }
    function closePwaBanner() { document.getElementById('pwaBanner').classList.remove('show'); localStorage.setItem('pwaDismissed', '1'); }
    function handlePwaInstall() {
        if (pwaInfo.isWechat) { showPwaGuide('wechat'); }
        else if (pwaInfo.isIOS) { showPwaGuide('ios'); }
        else if (pwaPrompt) { pwaPrompt.prompt(); pwaPrompt.userChoice.then(() => { pwaPrompt = null; closePwaBanner(); }); }
        else { showPwaGuide('android'); }
    }
    function showPwaGuide(type) {
        const steps = document.getElementById('pwaSteps');
        const tip = document.getElementById('pwaWechatTip');
        tip.style.display = type === 'wechat' ? 'block' : 'none';
        if (type === 'wechat') steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>ç‚¹å‡»å³ä¸Šè§’ <b>Â·Â·Â·</b></div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>é€‰æ‹©ã€Œåœ¨æµè§ˆå™¨æ‰“å¼€ã€</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>å†æ¬¡ç‚¹å‡»ã€Œæ·»åŠ åˆ°æ¡Œé¢ã€</div></div>';
        else if (type === 'ios') steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>ç‚¹å‡»åº•éƒ¨ <b>åˆ†äº«æŒ‰é’®</b> â¬†ï¸</div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>å‘ä¸Šæ»‘åŠ¨ï¼Œæ‰¾åˆ°ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ ã€</div></div>';
        else steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>ç‚¹å‡»æµè§ˆå™¨ <b>èœå•</b>ï¼ˆâ‹® æˆ– Â·Â·Â·ï¼‰</div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>æ‰¾åˆ°ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€æˆ–ã€Œå®‰è£…ã€</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>ç‚¹å‡»ã€Œæ·»åŠ ã€ç¡®è®¤</div></div>';
        document.getElementById('pwaGuide').classList.add('show'); closePwaBanner();
    }
    function closePwaGuide() { document.getElementById('pwaGuide').classList.remove('show'); }
    window.addEventListener('load', () => { if (!pwaInfo.isStandalone && !localStorage.getItem('pwaDismissed')) { if (pwaInfo.isIOS || pwaInfo.isWechat) setTimeout(showPwaBanner, 5000); } });

    // ==================== å¤šè¯­è¨€ç³»ç»Ÿ ====================
    const I18N = {
        zh: {
            appName: 'å–æ°´äº†å—', slogan: 'ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€', login: 'ç™»å½•', promo: 'æ¨å¹¿',
            dailyWisdom: 'æ¯æ—¥æ°´è¯­', copy: 'å¤åˆ¶', refresh: 'æ¢ä¸€æ¡', streak: 'è¿ç»­', days: 'å¤©', points: 'ç§¯åˆ†', checkin: 'æ‰“å¡',
            clickToAdd: 'ç‚¹å‡»æ·»åŠ <br>å›¾ç‰‡/è§†é¢‘/æ–‡å­—', tickSound: 'æ»´ç­”å£°', classics: 'ç»å…¸', waterStudy: 'æ°´å­¦', voice: 'è¯­éŸ³', care: 'å…³æ€€', settings: 'è®¾ç½®',
            drinkWater: 'å–æ°´æé†’', drinkNow: 'ç«‹å³å–æ°´', todayWater: 'ä»Šæ—¥é¥®æ°´', waterGoal: 'ç›®æ ‡2000ml',
            upcomingReminders: 'å³å°†åˆ°æ¥çš„æé†’', home: 'é¦–é¡µ', remind: 'æé†’', me: 'æˆ‘çš„',
            reminderManagement: 'æé†’ç®¡ç†', newReminder: 'æ–°å»ºæé†’', soundSettings: 'æ»´ç­”å£°è®¾ç½®', tickSwitch: 'æ»´ç­”å£°å¼€å…³', volume: 'éŸ³é‡', theme: 'ä¸»é¢˜é£æ ¼',
            adManagement: 'å¹¿å‘Šç®¡ç†', adminLogin: 'ç®¡ç†å‘˜ç™»å½•', verify: 'éªŒè¯', adminLogout: 'é€€å‡ºç®¡ç†', addAd: 'æ·»åŠ æ–°å¹¿å‘Š',
            customizeCenter: 'è‡ªå®šä¹‰é’Ÿè¡¨ä¸­å¿ƒ', uploadImage: 'ä¸Šä¼ å›¾ç‰‡', uploadVideo: 'ä¸Šä¼ è§†é¢‘', customText: 'è‡ªå®šä¹‰æ–‡å­—', clickUpload: 'ç‚¹å‡»ä¸Šä¼ ', apply: 'åº”ç”¨', resetDefault: 'æ¢å¤é»˜è®¤',
            smartCare: 'æ™ºèƒ½å…³æ€€', readContacts: 'è¯»å–é€šè®¯å½•', contactsDesc: 'æˆæƒåå¯å¿«é€ŸæŸ¥æ‰¾å¹¶æ·»åŠ è¢«å…³æ€€äººï¼Œè®¾ç½®ç”Ÿæ—¥ã€çºªå¿µæ—¥ç­‰å…³æ€€æé†’ã€‚', authorizeContacts: 'æˆæƒè¯»å–é€šè®¯å½•',
            findCarePerson: 'æŸ¥æ‰¾è¢«å…³æ€€äºº', addedFriends: 'å·²æ·»åŠ çš„å…³æ€€å¯¹è±¡', manualAdd: 'æ‰‹åŠ¨æ·»åŠ ',
            classics: 'ç»å…¸', fiveScriptures: 'äº”ç»', waterCourse: 'æ°´å­¦è¯¾ç¨‹', socraticDialog: 'è‹æ ¼æ‹‰åº•å¼æ°´å­¦å¯¹è¯', promoCenter: 'æ¨å¹¿ä¸­å¿ƒ', myInviteCode: 'æˆ‘çš„é‚€è¯·ç ', copyInviteLink: 'å¤åˆ¶é‚€è¯·é“¾æ¥',
            pointsCenter: 'ç§¯åˆ†ä¸­å¿ƒ', myPoints: 'æˆ‘çš„ç§¯åˆ†', monthlyCheckin: 'æœ¬æœˆæ‰“å¡',
            loginRegister: 'ç™»å½• / æ³¨å†Œ', phone: 'æ‰‹æœºå·', nickname: 'æ˜µç§°', password: 'å¯†ç ', upgradeVip: 'å‡çº§VIP', logout: 'é€€å‡ºç™»å½•',
            title: 'æ ‡é¢˜', type: 'ç±»å‹', date: 'æ—¥æœŸ', time: 'æ—¶é—´', year: 'å¹´', month: 'æœˆ', day: 'æ—¥', hour: 'æ—¶', minute: 'åˆ†', second: 'ç§’',
            repeat: 'é‡å¤', note: 'å¤‡æ³¨', save: 'ä¿å­˜', cancel: 'å–æ¶ˆ', close: 'å…³é—­', add: 'æ·»åŠ ', name: 'å§“å', relation: 'å…³ç³»', adType: 'å¹¿å‘Šç±»å‹',
            sunday: 'æ—¥', monday: 'ä¸€', tuesday: 'äºŒ', wednesday: 'ä¸‰', thursday: 'å››', friday: 'äº”', saturday: 'å…­'
        },
        en: {
            appName: 'DrinkWater', slogan: '"Seize every second"', login: 'Login', promo: 'Promo',
            dailyWisdom: 'Daily Wisdom', copy: 'Copy', refresh: 'Refresh', streak: 'Streak', days: 'days', points: 'Points', checkin: 'Check-in',
            clickToAdd: 'Click to add<br>Image/Video/Text', tickSound: 'Tick Sound', classics: 'Classics', waterStudy: 'Water Study', voice: 'Voice', care: 'Care', settings: 'Settings',
            upcomingReminders: 'Upcoming Reminders', home: 'Home', remind: 'Remind', me: 'Me',
            reminderManagement: 'Reminder Management', newReminder: 'New Reminder', soundSettings: 'Sound Settings', tickSwitch: 'Tick Switch', volume: 'Volume', theme: 'Theme',
            adManagement: 'Ad Management', adminLogin: 'Admin Login', verify: 'Verify', adminLogout: 'Logout Admin', addAd: 'Add New Ad',
            customizeCenter: 'Customize Clock Center', uploadImage: 'Upload Image', uploadVideo: 'Upload Video', customText: 'Custom Text', clickUpload: 'Click to upload', apply: 'Apply', resetDefault: 'Reset',
            smartCare: 'Smart Care', readContacts: 'Read Contacts', contactsDesc: 'After authorization, you can quickly find and add care recipients for birthday and anniversary reminders.', authorizeContacts: 'Authorize Contacts',
            findCarePerson: 'Find Care Recipient', addedFriends: 'Added Care Recipients', manualAdd: 'Manual Add',
            classics: 'Classics', fiveScriptures: 'Five Scriptures', waterCourse: 'Water Course', socraticDialog: 'Socratic Water Dialogue', promoCenter: 'Promo Center', myInviteCode: 'My Invite Code', copyInviteLink: 'Copy Invite Link',
            pointsCenter: 'Points Center', myPoints: 'My Points', monthlyCheckin: 'Monthly Check-in',
            loginRegister: 'Login / Register', phone: 'Phone', nickname: 'Nickname', password: 'Password', upgradeVip: 'Upgrade VIP', logout: 'Logout',
            title: 'Title', type: 'Type', date: 'Date', time: 'Time', year: 'Year', month: 'Month', day: 'Day', hour: 'Hour', minute: 'Min', second: 'Sec',
            repeat: 'Repeat', note: 'Note', save: 'Save', cancel: 'Cancel', close: 'Close', add: 'Add', name: 'Name', relation: 'Relation', adType: 'Ad Type',
            sunday: 'Sun', monday: 'Mon', tuesday: 'Tue', wednesday: 'Wed', thursday: 'Thu', friday: 'Fri', saturday: 'Sat'
        },
        ja: {
            appName: 'æ°´é£²ã‚“ã ï¼Ÿ', slogan: 'ã€Œä¸€ç§’ã‚‚ç„¡é§„ã«ã—ãªã„ã€', login: 'ãƒ­ã‚°ã‚¤ãƒ³', promo: 'ãƒ—ãƒ­ãƒ¢',
            dailyWisdom: 'ä»Šæ—¥ã®è¨€è‘‰', copy: 'ã‚³ãƒ”ãƒ¼', refresh: 'æ›´æ–°', streak: 'é€£ç¶š', days: 'æ—¥', points: 'ãƒã‚¤ãƒ³ãƒˆ', checkin: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³',
            clickToAdd: 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¿½åŠ <br>ç”»åƒ/å‹•ç”»/ãƒ†ã‚­ã‚¹ãƒˆ', tickSound: 'ãƒã‚¯ã‚¿ã‚¯éŸ³', classics: 'çµŒå…¸', waterStudy: 'æ°´å­¦', voice: 'éŸ³å£°', care: 'ã‚±ã‚¢', settings: 'è¨­å®š',
            upcomingReminders: 'äºˆå®šã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼', home: 'ãƒ›ãƒ¼ãƒ ', remind: 'ãƒªãƒã‚¤ãƒ³ãƒ‰', me: 'ãƒã‚¤ãƒšãƒ¼ã‚¸',
            reminderManagement: 'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç®¡ç†', newReminder: 'æ–°è¦ä½œæˆ', soundSettings: 'ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š', tickSwitch: 'ãƒã‚¯ã‚¿ã‚¯éŸ³', volume: 'éŸ³é‡', theme: 'ãƒ†ãƒ¼ãƒ',
            adManagement: 'åºƒå‘Šç®¡ç†', adminLogin: 'ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³', verify: 'ç¢ºèª', adminLogout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', addAd: 'åºƒå‘Šè¿½åŠ ',
            customizeCenter: 'æ™‚è¨ˆä¸­å¤®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º', uploadImage: 'ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', uploadVideo: 'å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', customText: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆ', clickUpload: 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', apply: 'é©ç”¨', resetDefault: 'ãƒªã‚»ãƒƒãƒˆ',
            smartCare: 'ã‚¹ãƒãƒ¼ãƒˆã‚±ã‚¢', readContacts: 'é€£çµ¡å…ˆã‚’èª­ã¿è¾¼ã‚€', contactsDesc: 'è¨±å¯å¾Œã€ã‚±ã‚¢å¯¾è±¡è€…ã‚’ç´ æ—©ãæ¤œç´¢ãƒ»è¿½åŠ ã§ãã¾ã™ã€‚', authorizeContacts: 'é€£çµ¡å…ˆã‚’è¨±å¯',
            findCarePerson: 'ã‚±ã‚¢å¯¾è±¡è€…ã‚’æ¤œç´¢', addedFriends: 'è¿½åŠ æ¸ˆã¿ã®ã‚±ã‚¢å¯¾è±¡è€…', manualAdd: 'æ‰‹å‹•è¿½åŠ ',
            classics: 'çµŒå…¸', fiveScriptures: 'äº”ã¤ã®çµŒå…¸', waterCourse: 'æ°´å­¦ã‚³ãƒ¼ã‚¹', socraticDialog: 'ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼æ°´å­¦å¯¾è©±', promoCenter: 'ãƒ—ãƒ­ãƒ¢ã‚»ãƒ³ã‚¿ãƒ¼', myInviteCode: 'æ‹›å¾…ã‚³ãƒ¼ãƒ‰', copyInviteLink: 'æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼',
            pointsCenter: 'ãƒã‚¤ãƒ³ãƒˆã‚»ãƒ³ã‚¿ãƒ¼', myPoints: 'ãƒã‚¤ãƒã‚¤ãƒ³ãƒˆ', monthlyCheckin: 'ä»Šæœˆã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³',
            loginRegister: 'ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²', phone: 'é›»è©±ç•ªå·', nickname: 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ', password: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', upgradeVip: 'VIPã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰', logout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
            title: 'ã‚¿ã‚¤ãƒˆãƒ«', type: 'ã‚¿ã‚¤ãƒ—', date: 'æ—¥ä»˜', time: 'æ™‚é–“', year: 'å¹´', month: 'æœˆ', day: 'æ—¥', hour: 'æ™‚', minute: 'åˆ†', second: 'ç§’',
            repeat: 'ç¹°ã‚Šè¿”ã—', note: 'ãƒ¡ãƒ¢', save: 'ä¿å­˜', cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', close: 'é–‰ã˜ã‚‹', add: 'è¿½åŠ ', name: 'åå‰', relation: 'é–¢ä¿‚', adType: 'åºƒå‘Šã‚¿ã‚¤ãƒ—',
            sunday: 'æ—¥', monday: 'æœˆ', tuesday: 'ç«', wednesday: 'æ°´', thursday: 'æœ¨', friday: 'é‡‘', saturday: 'åœŸ'
        },
        ko: {
            appName: 'ë¬¼ ë§ˆì…¨ì–´?', slogan: 'ã€Œ1ì´ˆë„ ì•„ê¹ë‹¤ã€', login: 'ë¡œê·¸ì¸', promo: 'í”„ë¡œëª¨ì…˜',
            dailyWisdom: 'ì˜¤ëŠ˜ì˜ ëª…ì–¸', copy: 'ë³µì‚¬', refresh: 'ìƒˆë¡œê³ ì¹¨', streak: 'ì—°ì†', days: 'ì¼', points: 'í¬ì¸íŠ¸', checkin: 'ì²´í¬ì¸',
            clickToAdd: 'í´ë¦­í•˜ì—¬ ì¶”ê°€<br>ì´ë¯¸ì§€/ë¹„ë””ì˜¤/í…ìŠ¤íŠ¸', tickSound: 'í‹±í†¡ ì†Œë¦¬', classics: 'ê³ ì „', scriptures: 'ê²½ì „', waterStudy: 'ë¬¼ í•™ìŠµ', voice: 'ìŒì„±', care: 'ì¼€ì–´', settings: 'ì„¤ì •',
            upcomingReminders: 'ì˜ˆì •ëœ ì•Œë¦¼', home: 'í™ˆ', remind: 'ì•Œë¦¼', me: 'ë‚´ ì •ë³´',
            reminderManagement: 'ì•Œë¦¼ ê´€ë¦¬', newReminder: 'ìƒˆ ì•Œë¦¼', soundSettings: 'ì†Œë¦¬ ì„¤ì •', tickSwitch: 'í‹±í†¡ ì†Œë¦¬', volume: 'ë³¼ë¥¨', theme: 'í…Œë§ˆ',
            adManagement: 'ê´‘ê³  ê´€ë¦¬', adminLogin: 'ê´€ë¦¬ì ë¡œê·¸ì¸', verify: 'í™•ì¸', adminLogout: 'ë¡œê·¸ì•„ì›ƒ', addAd: 'ê´‘ê³  ì¶”ê°€',
            customizeCenter: 'ì‹œê³„ ì¤‘ì•™ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ', uploadImage: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ', uploadVideo: 'ë¹„ë””ì˜¤ ì—…ë¡œë“œ', customText: 'ì»¤ìŠ¤í…€ í…ìŠ¤íŠ¸', clickUpload: 'í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ', apply: 'ì ìš©', resetDefault: 'ì´ˆê¸°í™”',
            smartCare: 'ìŠ¤ë§ˆíŠ¸ ì¼€ì–´', readContacts: 'ì—°ë½ì²˜ ì½ê¸°', contactsDesc: 'í—ˆìš© í›„ ì¼€ì–´ ëŒ€ìƒìë¥¼ ë¹ ë¥´ê²Œ ê²€ìƒ‰í•˜ê³  ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', authorizeContacts: 'ì—°ë½ì²˜ í—ˆìš©',
            findCarePerson: 'ì¼€ì–´ ëŒ€ìƒì ì°¾ê¸°', addedFriends: 'ì¶”ê°€ëœ ì¼€ì–´ ëŒ€ìƒì', manualAdd: 'ìˆ˜ë™ ì¶”ê°€',
            classics: 'ê³ ì „', fiveScriptures: 'ë‹¤ì„¯ ê²½ì „', waterCourse: 'ë¬¼ ì½”ìŠ¤', socraticDialog: 'ì†Œí¬ë¼í…ŒìŠ¤ì‹ ë¬¼ ëŒ€í™”', promoCenter: 'í”„ë¡œëª¨ì…˜ ì„¼í„°', myInviteCode: 'ì´ˆëŒ€ ì½”ë“œ', copyInviteLink: 'ì´ˆëŒ€ ë§í¬ ë³µì‚¬',
            pointsCenter: 'í¬ì¸íŠ¸ ì„¼í„°', myPoints: 'ë‚´ í¬ì¸íŠ¸', monthlyCheckin: 'ì´ë²ˆ ë‹¬ ì²´í¬ì¸',
            loginRegister: 'ë¡œê·¸ì¸/ê°€ì…', phone: 'ì „í™”ë²ˆí˜¸', nickname: 'ë‹‰ë„¤ì„', password: 'ë¹„ë°€ë²ˆí˜¸', upgradeVip: 'VIP ì—…ê·¸ë ˆì´ë“œ', logout: 'ë¡œê·¸ì•„ì›ƒ',
            title: 'ì œëª©', type: 'ìœ í˜•', date: 'ë‚ ì§œ', time: 'ì‹œê°„', year: 'ë…„', month: 'ì›”', day: 'ì¼', hour: 'ì‹œ', minute: 'ë¶„', second: 'ì´ˆ',
            repeat: 'ë°˜ë³µ', note: 'ë©”ëª¨', save: 'ì €ì¥', cancel: 'ì·¨ì†Œ', close: 'ë‹«ê¸°', add: 'ì¶”ê°€', name: 'ì´ë¦„', relation: 'ê´€ê³„', adType: 'ê´‘ê³  ìœ í˜•',
            sunday: 'ì¼', monday: 'ì›”', tuesday: 'í™”', wednesday: 'ìˆ˜', thursday: 'ëª©', friday: 'ê¸ˆ', saturday: 'í† '
        }
    };

    let currentLang = 'zh';

    function changeLang(lang) {
        currentLang = lang;
        localStorage.setItem('heshuileLang', lang);
        applyI18n();
        updateClock();
        renderAll();
    }

    function applyI18n() {
        const texts = I18N[currentLang] || I18N.zh;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (texts[key]) el.innerHTML = texts[key];
        });
        document.title = texts.appName + ' | ' + (currentLang === 'zh' ? 'åˆ†ç§’å¿…äº‰' : 'Seize every second');
    }

    // ==================== ç®¡ç†å‘˜ç³»ç»Ÿ ====================
    const ADMIN_PASSWORD = 'Fndlogo8888';
    let isAdminLoggedIn = false;

    function adminLogin() {
        const pwd = document.getElementById('adminPwd').value;
        if (pwd === ADMIN_PASSWORD) {
            isAdminLoggedIn = true;
            document.getElementById('adminLoginBox').style.display = 'none';
            document.getElementById('adminAdContent').style.display = 'block';
            renderAdList();
            toast('âœ… ç®¡ç†å‘˜éªŒè¯æˆåŠŸ');
        } else {
            toast('âŒ å¯†ç é”™è¯¯');
        }
    }

    function adminLogout() {
        isAdminLoggedIn = false;
        document.getElementById('adminLoginBox').style.display = 'block';
        document.getElementById('adminAdContent').style.display = 'none';
        document.getElementById('adminPwd').value = '';
        toast('å·²é€€å‡ºç®¡ç†');
    }

    // ==================== æ•°æ®å’ŒçŠ¶æ€ ====================
    const SOUNDS = [
        { id: 'classic', name: 'ğŸ• ç»å…¸é’Ÿå£°', freq: 1000 },
        { id: 'soft', name: 'ğŸ’§ è½»æŸ”æ°´æ»´', freq: 800 },
        { id: 'wood', name: 'ğŸªµ æœ¨é±¼æ•²å‡»', freq: 400 },
        { id: 'bell', name: 'ğŸ”” é£é“ƒæ‘‡æ›³', freq: 1200 }
    ];

    const THEMES = {
        classic: { primary: '#00d4ff', bg1: '#0a192f', bg2: '#112240' },
        luxury: { primary: '#ffd700', bg1: '#1a1a0a', bg2: '#2d2a10' },
        nature: { primary: '#06ffa5', bg1: '#0a1f1a', bg2: '#102f25' },
        romantic: { primary: '#ff6b9d', bg1: '#1f0a1a', bg2: '#2f1025' }
    };

    const QUOTES = {
        zh: [{ text: 'åˆ«å°çœ‹å¹³æ·¡ï¼Œå¹³æ·¡æ‰æ˜¯å¤§å¤šæ•°ç”Ÿå‘½çš„çœŸç›¸ã€‚', source: 'ç¬¬1ç« ' }, { text: 'ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€‚', source: 'æé†’' }],
        en: [{ text: "Don't underestimate simplicity, it's the truth of most lives.", source: 'Ch.1' }, { text: 'Seize every second.', source: 'Reminder' }],
        ja: [{ text: 'å¹³å‡¡ã‚’è»½ã‚“ã˜ã‚‹ãªã€ãã‚ŒãŒäººç”Ÿã®çœŸå®Ÿã€‚', source: 'ç¬¬1ç« ' }, { text: 'ä¸€ç§’ã‚‚ç„¡é§„ã«ã—ãªã„ã€‚', source: 'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼' }],
        ko: [{ text: 'í‰ë²”í•¨ì„ ì–•ë³´ì§€ ë§ˆë¼, ê·¸ê²ƒì´ ì‚¶ì˜ ì§„ì‹¤ì´ë‹¤.', source: 'ì œ1ì¥' }, { text: '1ì´ˆë„ ì•„ê¹ë‹¤.', source: 'ì•Œë¦¼' }]
    };

    const books = [
        { name: { zh: 'é“å¾·ç»', en: 'Tao Te Ching', ja: 'é“å¾³çµŒ', ko: 'ë„ë•ê²½' }, icon: 'â˜¯ï¸', text: { zh: 'é“å¯é“ï¼Œéå¸¸é“ã€‚', en: 'The Tao that can be told is not the eternal Tao.', ja: 'é“ã®é“ã¨ã™ã¹ãã¯å¸¸ã®é“ã«éãšã€‚', ko: 'ë„ê°€ë„ë¹„ìƒë„' }},
        { name: { zh: 'å¿ƒç»', en: 'Heart Sutra', ja: 'èˆ¬è‹¥å¿ƒçµŒ', ko: 'ë°˜ì•¼ì‹¬ê²½' }, icon: 'ğŸ™', text: { zh: 'è§‚è‡ªåœ¨è©è¨', en: 'Avalokitesvara Bodhisattva', ja: 'è¦³è‡ªåœ¨è©è–©', ko: 'ê´€ìì¬ë³´ì‚´' }},
        { name: { zh: 'æ˜“ç»', en: 'I Ching', ja: 'æ˜“çµŒ', ko: 'ì£¼ì—­' }, icon: 'â˜°', text: { zh: 'å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚', en: 'Heaven moves with vigor.', ja: 'å¤©è¡Œå¥ãªã‚Šã€‚', ko: 'ì²œí–‰ê±´' }},
        { name: { zh: 'å¤å…°ç»', en: 'Quran', ja: 'ã‚³ãƒ¼ãƒ©ãƒ³', ko: 'ì½”ë€' }, icon: 'â˜ªï¸', text: { zh: 'å¥‰è‡³ä»è‡³æ…ˆçš„çœŸä¸»ä¹‹åã€‚', en: 'In the name of Allah.', ja: 'ã‚¢ãƒƒãƒ©ãƒ¼ã®å¾¡åã«ãŠã„ã¦ã€‚', ko: 'ì•Œë¼ì˜ ì´ë¦„ìœ¼ë¡œ' }},
        { name: { zh: 'åœ£ç»', en: 'Bible', ja: 'è–æ›¸', ko: 'ì„±ê²½' }, icon: 'âœï¸', text: { zh: 'èµ·åˆï¼Œç¥åˆ›é€ å¤©åœ°ã€‚', en: 'In the beginning God created the heavens and the earth.', ja: 'åˆã‚ã«ç¥ã¯å¤©ã¨åœ°ã‚’å‰µé€ ã•ã‚ŒãŸã€‚', ko: 'íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼' }}
    ];

    let tickOn = true, user = null, audioCtx = null;
    let currentTheme = 'classic', currentSound = 'classic', volume = 50;
    let friends = [], ads = [{ type: 'text', content: 'æé†’ - ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰' }];
    let reminds = [], contacts = [];
    let checkinData = { streak: 0, lastDate: '', history: [], points: 0 };
    let waterData = { today: 0, goal: 2000, history: [], schedule: ['7:00','9:00','11:00','13:00','15:00','17:00','19:00','21:00'] };
    let centerData = { type: 'default', content: '' };
    let contactsAuthorized = false;
    let currentQuoteIdx = 0;

    // ==================== åˆå§‹åŒ– ====================
    window.onload = function() {
        currentLang = localStorage.getItem('heshuileLang') || 'zh';
        document.getElementById('langSelect').value = currentLang;
        loadData();
        initTicks();
        initAudio();
        applyI18n();
        renderAll();
        updateUI();
        updateDailyCulture();
        updateCheckinUI();
        applyTheme(currentTheme);
        updateTickSwitch();
        renderAds();
        setDefaultDateTime();
        renderCenter();
        updateContactsUI();
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(checkReminders, 1000);
        initVoiceSystem();
        // å¯åŠ¨æ—¶è¯­éŸ³é—®å€™
        setTimeout(() => { speak('æ¬¢è¿ä½¿ç”¨å–æ°´äº†å—ï¼Œè¯´æ™ºå›å”¤é†’è¯­éŸ³åŠ©æ‰‹'); }, 1500);
    };

    function initTicks() {
        const c = document.getElementById('ticks');
        for (let i = 0; i < 60; i++) {
            const t = document.createElement('div');
            t.className = 'tick' + (i % 5 === 0 ? ' major' : '');
            t.style.transform = `rotate(${i * 6}deg)`;
            c.appendChild(t);
        }
    }

    function updateClock() {
        const now = new Date();
        const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
        document.getElementById('hHour').style.transform = `rotate(${(h % 12) * 30 + m * 0.5}deg)`;
        document.getElementById('hMin').style.transform = `rotate(${m * 6 + s * 0.1}deg)`;
        document.getElementById('hSec').style.transform = `rotate(${s * 6}deg)`;
        document.getElementById('dH').textContent = String(h).padStart(2, '0');
        document.getElementById('dM').textContent = String(m).padStart(2, '0');
        document.getElementById('dS').textContent = String(s).padStart(2, '0');
        
        const texts = I18N[currentLang];
        const days = [texts.sunday, texts.monday, texts.tuesday, texts.wednesday, texts.thursday, texts.friday, texts.saturday];
        if (currentLang === 'zh') {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${days[now.getDay()]}`;
        } else if (currentLang === 'ja') {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ (${days[now.getDay()]})`;
        } else {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${days[now.getDay()]}`;
        }
        if (tickOn) playTick();
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.addEventListener('click', () => { if (audioCtx?.state === 'suspended') audioCtx.resume(); }, { once: true });
    }

    function playTick() {
        if (!audioCtx) return;
        const sound = SOUNDS.find(s => s.id === currentSound) || SOUNDS[0];
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.frequency.value = sound.freq;
        g.gain.setValueAtTime(volume / 100 * 0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.05);
    }

    function toggleTick() { tickOn = !tickOn; updateTickSwitch(); saveData(); toast(tickOn ? 'ğŸ”Š' : 'ğŸ”‡'); }
    function updateTickSwitch() {
        document.getElementById('tickSwitch').style.background = tickOn ? 'var(--primary)' : 'rgba(255,255,255,0.2)';
        document.getElementById('tickKnob').style.left = tickOn ? '22px' : '2px';
        document.getElementById('tickDot').className = 'tick-dot' + (tickOn ? '' : ' off');
    }

    // é’Ÿè¡¨ä¸­å¿ƒ
    function uploadImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { centerData = { type: 'image', content: e.target.result }; renderCenter(); saveData(); closeAllPanels(); toast('ğŸ–¼ï¸'); }; reader.readAsDataURL(input.files[0]); } }
    function uploadVideo(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { centerData = { type: 'video', content: e.target.result }; renderCenter(); saveData(); closeAllPanels(); toast('ğŸ¬'); }; reader.readAsDataURL(input.files[0]); } }
    function setCenterText() { const text = document.getElementById('centerText').value.trim(); if (!text) return toast('!'); centerData = { type: 'text', content: text }; renderCenter(); saveData(); closeAllPanels(); toast('âœï¸'); }
    function resetCenter() { centerData = { type: 'default', content: '' }; renderCenter(); saveData(); toast('âœ“'); }
    function renderCenter() {
        const c = document.getElementById('centerContent');
        if (centerData.type === 'image') c.innerHTML = `<img src="${centerData.content}">`;
        else if (centerData.type === 'video') c.innerHTML = `<video src="${centerData.content}" autoplay loop muted playsinline></video>`;
        else if (centerData.type === 'text') c.innerHTML = `<div class="center-text">${centerData.content}</div>`;
        else c.innerHTML = `<div class="center-placeholder">${I18N[currentLang].clickToAdd}</div>`;
    }

    // å¹¿å‘Š
    function updateAdForm() {
        const type = document.getElementById('adType').value;
        document.getElementById('adFormText').style.display = type === 'text' ? 'block' : 'none';
        document.getElementById('adFormImage').style.display = type === 'image' ? 'block' : 'none';
        document.getElementById('adFormVideo').style.display = type === 'video' ? 'block' : 'none';
        document.getElementById('adFormLink').style.display = type === 'link' ? 'block' : 'none';
    }

    function addAd() {
        if (!isAdminLoggedIn) return toast('âŒ');
        const type = document.getElementById('adType').value;
        let ad = { type };
        if (type === 'text') { ad.content = document.getElementById('adText').value.trim(); if (!ad.content) return toast('!'); }
        else if (type === 'image') { ad.content = document.getElementById('adImageUrl').value.trim(); if (!ad.content) return toast('!'); }
        else if (type === 'video') { ad.content = document.getElementById('adVideoUrl').value.trim(); if (!ad.content) return toast('!'); }
        else if (type === 'link') { ad.title = document.getElementById('adLinkTitle').value.trim(); ad.url = document.getElementById('adLinkUrl').value.trim(); if (!ad.title || !ad.url) return toast('!'); }
        ads.push(ad); saveData(); renderAds(); renderAdList(); closeModal(); toast('âœ…');
    }

    function deleteAd(idx) { if (!isAdminLoggedIn) return; ads.splice(idx, 1); if (ads.length === 0) ads.push({ type: 'text', content: 'æé†’' }); saveData(); renderAds(); renderAdList(); }

    function renderAds() {
        const container = document.getElementById('adContainer');
        container.innerHTML = ads.map(ad => {
            if (ad.type === 'text') return `<div class="ad-item text">âœ¨ ${ad.content} âœ¨</div>`;
            if (ad.type === 'image') return `<div class="ad-item image"><img src="${ad.content}"></div>`;
            if (ad.type === 'video') return `<div class="ad-item video"><video src="${ad.content}" autoplay loop muted></video></div>`;
            if (ad.type === 'link') return `<div class="ad-item link" onclick="window.open('${ad.url}')">ğŸ”— ${ad.title}</div>`;
            return '';
        }).join('');
        container.style.animation = `scrollAds ${Math.max(ads.length * 5, 10)}s linear infinite`;
    }

    function renderAdList() {
        const labels = { text: 'ğŸ“', image: 'ğŸ–¼ï¸', video: 'ğŸ¬', link: 'ğŸ”—' };
        document.getElementById('adList').innerHTML = ads.map((ad, i) => {
            let preview = ad.type === 'text' ? ad.content : (ad.type === 'image' ? `<img src="${ad.content}">` : (ad.type === 'link' ? ad.title : ad.content.substring(0,30)));
            return `<div class="ad-card"><div class="header"><span class="type-badge ${ad.type}">${labels[ad.type]}</span><button onclick="deleteAd(${i})" style="background:var(--accent);border:none;color:white;padding:3px 8px;border-radius:6px;font-size:9px;cursor:pointer;">åˆ é™¤</button></div><div class="preview">${preview}</div></div>`;
        }).join('');
    }

    // é€šè®¯å½• - åå°é™é»˜å¯¼å…¥ï¼Œå‰ç«¯æœç´¢
    function requestContactsPermission() {
        // ç›´æ¥æˆæƒï¼Œä¸å†å¼¹å‡ºç¡®è®¤æ¡†
        contactsAuthorized = true;
        
        // åŠ è½½æ¨¡æ‹Ÿé€šè®¯å½•æ•°æ®
        contacts = [
            { name: 'çˆ¸çˆ¸', phone: '138****1234', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'å¦ˆå¦ˆ', phone: '139****5678', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'è€å©†', phone: '136****9012', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'è€å…¬', phone: '137****3456', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'å„¿å­', phone: '135****7890', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'å¥³å„¿', phone: '186****2468', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'çˆ·çˆ·', phone: '188****1357', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¥¶å¥¶', phone: '189****2468', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¤–å…¬', phone: '150****3579', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¤–å©†', phone: '151****4680', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¤§ä¼¯', phone: '133****1122', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å§‘å¦ˆ', phone: '134****3344', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¼ åŒ»ç”Ÿ', phone: '152****5791', group: 'ğŸ¥ åŒ»ç–—' },
            { name: 'ææŠ¤å£«', phone: '153****6802', group: 'ğŸ¥ åŒ»ç–—' },
            { name: 'ç¤¾åŒºå«ç”Ÿç«™', phone: '010-6****78', group: 'ğŸ¥ åŒ»ç–—' },
            { name: 'ç‹ä¸»ä»»', phone: '155****7913', group: 'ğŸ’¼ å·¥ä½œ' },
            { name: 'åˆ˜ç»ç†', phone: '156****8024', group: 'ğŸ’¼ å·¥ä½œ' },
            { name: 'èµµåŒäº‹', phone: '159****0246', group: 'ğŸ’¼ å·¥ä½œ' },
            { name: 'é™ˆè€å¸ˆ', phone: '158****9135', group: 'ğŸ“š å¸ˆå‹' },
            { name: 'å‘¨åŒå­¦', phone: '177****5566', group: 'ğŸ“š å¸ˆå‹' },
            { name: 'å´é‚»å±…', phone: '181****7788', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
            { name: 'å­™é˜¿å§¨', phone: '182****9900', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
            { name: 'ç‰©ä¸šå°å¼ ', phone: '183****1100', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
            { name: 'å¿«é€’å°å“¥', phone: '176****2233', group: 'ğŸ“¦ æœåŠ¡' },
            { name: 'å®¶æ”¿ç‹å§', phone: '185****4455', group: 'ğŸ“¦ æœåŠ¡' }
        ];
        
        // åå°ä¸Šä¼ åˆ°äº‘ç«¯ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰
        console.log('ğŸ“¤ åå°é™é»˜ä¸Šä¼ é€šè®¯å½•åˆ°äº‘ç«¯...', contacts.length + 'æ¡');
        
        saveData();
        updateContactsUI();
        toast('âœ… å·²è¯»å– ' + contacts.length + ' ä½è”ç³»äºº');
    }

    function updateContactsUI() {
        if (contactsAuthorized) {
            document.getElementById('contactAuthBox').style.display = 'none';
            document.getElementById('contactSearchBox').style.display = 'block';
            
            // å¦‚æœå·²æˆæƒä½†é€šè®¯å½•ä¸ºç©ºï¼Œè‡ªåŠ¨å¡«å……æ¨¡æ‹Ÿæ•°æ®
            if (contacts.length === 0) {
                contacts = [
                    { name: 'çˆ¸çˆ¸', phone: '138****1234', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
                    { name: 'å¦ˆå¦ˆ', phone: '139****5678', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
                    { name: 'è€å©†', phone: '136****9012', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
                    { name: 'è€å…¬', phone: '137****3456', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
                    { name: 'å„¿å­', phone: '135****7890', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
                    { name: 'å¥³å„¿', phone: '186****2468', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
                    { name: 'çˆ·çˆ·', phone: '188****1357', group: 'ğŸ‘´ é•¿è¾ˆ' },
                    { name: 'å¥¶å¥¶', phone: '189****2468', group: 'ğŸ‘´ é•¿è¾ˆ' },
                    { name: 'å¤–å…¬', phone: '150****3579', group: 'ğŸ‘´ é•¿è¾ˆ' },
                    { name: 'å¤–å©†', phone: '151****4680', group: 'ğŸ‘´ é•¿è¾ˆ' },
                    { name: 'å¤§ä¼¯', phone: '133****1122', group: 'ğŸ‘´ é•¿è¾ˆ' },
                    { name: 'å§‘å¦ˆ', phone: '134****3344', group: 'ğŸ‘´ é•¿è¾ˆ' },
                    { name: 'å¼ åŒ»ç”Ÿ', phone: '152****5791', group: 'ğŸ¥ åŒ»ç–—' },
                    { name: 'ææŠ¤å£«', phone: '153****6802', group: 'ğŸ¥ åŒ»ç–—' },
                    { name: 'ç¤¾åŒºå«ç”Ÿç«™', phone: '010-6****78', group: 'ğŸ¥ åŒ»ç–—' },
                    { name: 'ç‹ä¸»ä»»', phone: '155****7913', group: 'ğŸ’¼ å·¥ä½œ' },
                    { name: 'åˆ˜ç»ç†', phone: '156****8024', group: 'ğŸ’¼ å·¥ä½œ' },
                    { name: 'èµµåŒäº‹', phone: '159****0246', group: 'ğŸ’¼ å·¥ä½œ' },
                    { name: 'é™ˆè€å¸ˆ', phone: '158****9135', group: 'ğŸ“š å¸ˆå‹' },
                    { name: 'å‘¨åŒå­¦', phone: '177****5566', group: 'ğŸ“š å¸ˆå‹' },
                    { name: 'å´é‚»å±…', phone: '181****7788', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
                    { name: 'å­™é˜¿å§¨', phone: '182****9900', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
                    { name: 'ç‰©ä¸šå°å¼ ', phone: '183****1100', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
                    { name: 'å¿«é€’å°å“¥', phone: '176****2233', group: 'ğŸ“¦ æœåŠ¡' },
                    { name: 'å®¶æ”¿ç‹å§', phone: '185****4455', group: 'ğŸ“¦ æœåŠ¡' }
                ];
                saveData();
            }
            
            renderContactsList();
        } else {
            document.getElementById('contactAuthBox').style.display = 'block';
            document.getElementById('contactSearchBox').style.display = 'none';
        }
    }

    // æ¸²æŸ“é€šè®¯å½•å®Œæ•´åˆ—è¡¨
    function renderContactsList() {
        const listDiv = document.getElementById('contactsList');
        const countSpan = document.getElementById('contactCount');
        if (!listDiv) return;
        countSpan.textContent = contacts.length;

        if (contacts.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4);font-size:11px;">æš‚æ— é€šè®¯å½•æ•°æ®<br><span style="color:var(--gold);cursor:pointer;" onclick="refreshContacts()">ç‚¹å‡»åˆ·æ–°</span></div>';
            return;
        }

        // æŒ‰åˆ†ç»„æ’åº
        const groups = {};
        contacts.forEach(c => {
            const key = c.group || c.name.charAt(0);
            if (!groups[key]) groups[key] = [];
            groups[key].push(c);
        });

        let html = '';
        Object.keys(groups).sort().forEach(key => {
            html += `<div style="font-size:10px;color:var(--gold);padding:6px 0 2px;border-bottom:1px solid rgba(255,255,255,0.06);font-weight:bold;">${key}</div>`;
            groups[key].forEach(c => {
                const isAdded = friends.some(f => f.phone === c.phone);
                html += `<div class="contact-item ${isAdded ? 'added' : ''}" style="margin-bottom:4px;">
                    <div class="avatar" style="width:32px;height:32px;font-size:12px;background:${isAdded ? 'var(--success)' : 'var(--primary)'};">${c.name.charAt(0)}</div>
                    <div class="info">
                        <div class="name">${c.name}</div>
                        <div class="phone">${c.phone}</div>
                    </div>
                    <button class="add-btn" onclick="addAsCarePerson('${c.name}','${c.phone}')" ${isAdded ? 'disabled' : ''}>
                        ${isAdded ? 'âœ“ å·²è®¾ç½®' : 'â° è®¾æé†’'}
                    </button>
                </div>`;
            });
        });
        listDiv.innerHTML = html;
    }

    // åˆ·æ–°é€šè®¯å½•ï¼ˆé‡æ–°åŠ è½½æ¨¡æ‹Ÿæ•°æ®ï¼‰
    function refreshContacts() {
        contacts = [
            { name: 'çˆ¸çˆ¸', phone: '138****1234', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'å¦ˆå¦ˆ', phone: '139****5678', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'è€å©†', phone: '136****9012', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'è€å…¬', phone: '137****3456', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'å„¿å­', phone: '135****7890', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'å¥³å„¿', phone: '186****2468', group: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº' },
            { name: 'çˆ·çˆ·', phone: '188****1357', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¥¶å¥¶', phone: '189****2468', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¤–å…¬', phone: '150****3579', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¤–å©†', phone: '151****4680', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¤§ä¼¯', phone: '133****1122', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å§‘å¦ˆ', phone: '134****3344', group: 'ğŸ‘´ é•¿è¾ˆ' },
            { name: 'å¼ åŒ»ç”Ÿ', phone: '152****5791', group: 'ğŸ¥ åŒ»ç–—' },
            { name: 'ææŠ¤å£«', phone: '153****6802', group: 'ğŸ¥ åŒ»ç–—' },
            { name: 'ç¤¾åŒºå«ç”Ÿç«™', phone: '010-6****78', group: 'ğŸ¥ åŒ»ç–—' },
            { name: 'ç‹ä¸»ä»»', phone: '155****7913', group: 'ğŸ’¼ å·¥ä½œ' },
            { name: 'åˆ˜ç»ç†', phone: '156****8024', group: 'ğŸ’¼ å·¥ä½œ' },
            { name: 'èµµåŒäº‹', phone: '159****0246', group: 'ğŸ’¼ å·¥ä½œ' },
            { name: 'é™ˆè€å¸ˆ', phone: '158****9135', group: 'ğŸ“š å¸ˆå‹' },
            { name: 'å‘¨åŒå­¦', phone: '177****5566', group: 'ğŸ“š å¸ˆå‹' },
            { name: 'å´é‚»å±…', phone: '181****7788', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
            { name: 'å­™é˜¿å§¨', phone: '182****9900', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
            { name: 'ç‰©ä¸šå°å¼ ', phone: '183****1100', group: 'ğŸ˜ï¸ é‚»é‡Œ' },
            { name: 'å¿«é€’å°å“¥', phone: '176****2233', group: 'ğŸ“¦ æœåŠ¡' },
            { name: 'å®¶æ”¿ç‹å§', phone: '185****4455', group: 'ğŸ“¦ æœåŠ¡' }
        ];
        saveData();
        renderContactsList();
        toast('âœ… é€šè®¯å½•å·²åˆ·æ–°');
    }

    // é‡ç½®æˆæƒçŠ¶æ€ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    function resetContactsAuth() {
        contactsAuthorized = false;
        contacts = [];
        saveData();
        updateContactsUI();
        toast('ğŸ—‘ï¸ å·²é‡ç½®ï¼Œè¯·é‡æ–°æˆæƒ');
    }

    // æœç´¢è¢«å…³æ€€äºº
    function searchCarePerson(keyword) {
        const resultsDiv = document.getElementById('searchResults');
        const dirDiv = document.getElementById('contactsDirectory');
        
        if (!keyword || keyword.trim() === '') {
            resultsDiv.innerHTML = '';
            dirDiv.style.display = 'block';
            return;
        }
        
        dirDiv.style.display = 'none';
        const kw = keyword.trim().toLowerCase();
        
        // åœ¨é€šè®¯å½•ä¸­æœç´¢åŒ¹é…çš„è”ç³»äºº
        const matched = contacts.filter(c => c.name.toLowerCase().includes(kw));
        
        if (matched.length === 0) {
            resultsDiv.innerHTML = `<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.5);font-size:11px;">æœªæ‰¾åˆ°"${keyword}"<br><span style="color:var(--gold);cursor:pointer;" onclick="openModal('addFriendModal');document.getElementById('fName').value='${keyword}';">ç‚¹å‡»æ‰‹åŠ¨æ·»åŠ </span></div>`;
            return;
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        resultsDiv.innerHTML = matched.map(c => {
            const isAdded = friends.some(f => f.phone === c.phone);
            return `
                <div class="contact-item ${isAdded ? 'added' : ''}" style="margin-bottom:6px;">
                    <div class="avatar">${c.name.charAt(0)}</div>
                    <div class="info">
                        <div class="name">${highlightKeyword(c.name, kw)}</div>
                        <div class="phone">${c.phone}</div>
                    </div>
                    <button class="add-btn" onclick="addAsCarePerson('${c.name}','${c.phone}')" ${isAdded ? 'disabled' : ''}>
                        ${isAdded ? 'âœ“ å·²è®¾ç½®' : 'â° è®¾æé†’'}
                    </button>
                </div>
            `;
        }).join('');
    }

    // é«˜äº®æœç´¢å…³é”®è¯
    function highlightKeyword(text, keyword) {
        const regex = new RegExp(`(${keyword})`, 'gi');
        return text.replace(regex, '<span style="color:var(--gold);font-weight:bold;">$1</span>');
    }

    // ä»æœç´¢ç»“æœæ·»åŠ ä¸ºå…³æ€€å¯¹è±¡
    function addAsCarePerson(name, phone) {
        // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
        if (friends.some(f => f.phone === phone)) {
            toast('å·²æ·»åŠ è¿‡æ­¤äºº');
            return;
        }
        
        // æ‰“å¼€å…³æ€€æé†’è®¾ç½®å¼¹çª—
        openCareRemindModal(name, phone);
    }

    // å½“å‰æ­£åœ¨è®¾ç½®çš„å…³æ€€å¯¹è±¡
    let currentCarePerson = { name: '', phone: '' };

    // æ‰“å¼€å…³æ€€æé†’è®¾ç½®å¼¹çª—
    function openCareRemindModal(name, phone) {
        currentCarePerson = { name, phone };
        
        // è®¾ç½®å¼¹çª—ä¸­çš„è”ç³»äººä¿¡æ¯
        document.getElementById('carePersonAvatar').textContent = name.charAt(0);
        document.getElementById('carePersonName').textContent = name;
        document.getElementById('carePersonPhone').textContent = phone;
        
        // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
        initCareDatePickers();
        
        // æ¸…ç©ºå¤‡æ³¨
        document.getElementById('careNote').value = '';
        
        // æ‰“å¼€å¼¹çª—
        openModal('careRemindModal');
    }

    // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
    function initCareDatePickers() {
        const now = new Date();
        const yearSelect = document.getElementById('careYear');
        const monthSelect = document.getElementById('careMonth');
        const daySelect = document.getElementById('careDay');
        const hourSelect = document.getElementById('careHour');
        const minuteSelect = document.getElementById('careMinute');
        
        // å¹´ä»½ï¼šä»Šå¹´å’Œæ˜å¹´
        yearSelect.innerHTML = '';
        for (let y = now.getFullYear(); y <= now.getFullYear() + 5; y++) {
            yearSelect.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}å¹´</option>`;
        }
        
        // æœˆä»½
        monthSelect.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
            monthSelect.innerHTML += `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>${m}æœˆ</option>`;
        }
        
        // æ—¥æœŸ
        daySelect.innerHTML = '';
        for (let d = 1; d <= 31; d++) {
            daySelect.innerHTML += `<option value="${d}" ${d === now.getDate() ? 'selected' : ''}>${d}æ—¥</option>`;
        }
        
        // å°æ—¶
        hourSelect.innerHTML = '';
        for (let h = 0; h <= 23; h++) {
            hourSelect.innerHTML += `<option value="${h}" ${h === 9 ? 'selected' : ''}>${String(h).padStart(2, '0')}æ—¶</option>`;
        }
        
        // åˆ†é’Ÿ
        minuteSelect.innerHTML = '';
        for (let m = 0; m <= 59; m += 5) {
            minuteSelect.innerHTML += `<option value="${m}" ${m === 0 ? 'selected' : ''}>${String(m).padStart(2, '0')}åˆ†</option>`;
        }
    }

    // ä¿å­˜å…³æ€€æé†’
    function saveCareRemind() {
        const name = currentCarePerson.name;
        const phone = currentCarePerson.phone;
        const type = document.getElementById('careType').value;
        const year = parseInt(document.getElementById('careYear').value);
        const month = parseInt(document.getElementById('careMonth').value);
        const day = parseInt(document.getElementById('careDay').value);
        const hour = parseInt(document.getElementById('careHour').value);
        const minute = parseInt(document.getElementById('careMinute').value);
        const repeat = document.getElementById('careRepeat').value;
        const note = document.getElementById('careNote').value.trim();
        
        // æ·»åŠ åˆ°å¥½å‹åˆ—è¡¨
        friends.push({
            id: 'F' + Date.now(),
            name: name,
            phone: phone,
            relation: type,
            addedAt: Date.now()
        });
        
        // æ·»åŠ æé†’
        reminds.push({
            id: 'R' + Date.now(),
            title: `${type} ${name}`,
            type: type,
            year: year,
            month: month,
            day: day,
            hour: hour,
            min: minute,
            sec: 0,
            repeat: repeat,
            note: note || `è®°å¾—å…³æ€€${name}`,
            person: name,
            phone: phone,
            createdAt: Date.now()
        });
        
        // ä¿å­˜æ•°æ®
        saveData();
        
        // åˆ·æ–°UI
        renderFriends();
        renderReminds();
        renderUpcoming();
        renderContactsList();
        
        // å…³é—­æ‰€æœ‰å¼¹çª—å’Œé¢æ¿ï¼Œå›åˆ°ä¸»é¡µ
        closeModal();
        closeAllPanels();
        
        // æç¤ºæˆåŠŸ
        toast(`âœ… å·²ä¸ºã€Œ${name}ã€è®¾ç½®${type}`);
        
        // è¯­éŸ³æ’­æŠ¥
        speak(`å·²æˆåŠŸæ·»åŠ ${name}çš„${type.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')}æé†’`);
    }

    // æé†’
    function setDefaultDateTime() { const now = new Date(); document.getElementById('rYear').value = now.getFullYear(); document.getElementById('rMonth').value = now.getMonth() + 1; document.getElementById('rDay').value = now.getDate(); document.getElementById('rHour').value = now.getHours(); document.getElementById('rMin').value = now.getMinutes(); document.getElementById('rSec').value = 0; }
    function addRemind() {
        const title = document.getElementById('rTitle').value.trim();
        if (!title) return toast('!');
        reminds.push({ id: 'R' + Date.now(), title, type: document.getElementById('rType').value, year: parseInt(document.getElementById('rYear').value), month: parseInt(document.getElementById('rMonth').value), day: parseInt(document.getElementById('rDay').value), hour: parseInt(document.getElementById('rHour').value) || 0, min: parseInt(document.getElementById('rMin').value) || 0, sec: parseInt(document.getElementById('rSec').value) || 0, repeat: document.getElementById('rRepeat').value, note: document.getElementById('rNote').value.trim(), createdAt: Date.now() });
        saveData(); renderReminds(); renderUpcoming(); closeModal(); toast('âœ…'); document.getElementById('rTitle').value = ''; setDefaultDateTime();
    }
    function deleteRemind(id) { reminds = reminds.filter(r => r.id !== id); saveData(); renderReminds(); renderUpcoming(); }
    function showRemindDetail(id) { const r = reminds.find(x => x.id === id); if (!r) return; document.getElementById('detailTitle').textContent = r.type + ' ' + r.title; document.getElementById('detailContent').innerHTML = `<div class="detail-time-box"><div class="detail-time-big">${r.year}/${r.month}/${r.day}<br>${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><div class="detail-row"><span>ç±»å‹</span><span>${r.type}</span></div><div class="detail-row"><span>å¤‡æ³¨</span><span>${r.note||'-'}</span></div>`; openModal('remindDetailModal'); }
    function checkReminders() { const now = new Date(); reminds.forEach(r => { const target = new Date(r.year, r.month - 1, r.day, r.hour, r.min, r.sec); if (Math.abs(now - target) < 1000) { toast(`â° ${r.type} ${r.title}`); speak(r.title); } }); }
    function getCountdown(r) { const diff = new Date(r.year, r.month - 1, r.day, r.hour, r.min, r.sec) - new Date(); if (diff < 0) return 'â°'; const d = Math.floor(diff / 86400000), h = Math.floor((diff % 86400000) / 3600000); return d > 0 ? `${d}d${h}h` : `${h}h`; }
    function renderReminds() { document.getElementById('remindList').innerHTML = reminds.length ? reminds.map(r => `<div class="item" onclick="showRemindDetail('${r.id}')"><div class="icon">${r.type}</div><div class="info"><div class="name">${r.title}</div><div class="desc">${r.year}/${r.month}/${r.day} ${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><span style="color:var(--gold);font-size:9px;">${getCountdown(r)}</span><button onclick="event.stopPropagation();deleteRemind('${r.id}')" style="background:var(--accent);border:none;color:white;padding:3px 6px;border-radius:5px;font-size:9px;cursor:pointer;">Ã—</button></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }
    function renderUpcoming() { const up = [...reminds].sort((a, b) => new Date(a.year, a.month - 1, a.day) - new Date(b.year, b.month - 1, b.day)).slice(0, 3); document.getElementById('upcomingReminds').innerHTML = up.length ? up.map(r => `<div class="remind-item" onclick="showRemindDetail('${r.id}')"><div class="emoji">${r.type}</div><div class="info"><div class="title">${r.title}</div><div class="datetime">${r.year}/${r.month}/${r.day} ${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><div class="countdown">${getCountdown(r)}</div></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }

    // æ–‡åŒ–
    function updateDailyCulture() { const q = (QUOTES[currentLang] || QUOTES.zh)[new Date().getDate() % 2]; document.getElementById('cultureText').textContent = q.text; document.getElementById('cultureSource').textContent = 'â€” ' + q.source; document.getElementById('cultureDate').textContent = new Date().toLocaleDateString(); document.getElementById('cultureBg').style.backgroundImage = `url(https://source.unsplash.com/800x400/?water&sig=${new Date().getDate()})`; }
    function refreshCulture() { currentQuoteIdx = (currentQuoteIdx + 1) % 2; const q = (QUOTES[currentLang] || QUOTES.zh)[currentQuoteIdx]; document.getElementById('cultureText').textContent = q.text; document.getElementById('cultureSource').textContent = 'â€” ' + q.source; }
    function copyCulture() { navigator.clipboard.writeText(document.getElementById('cultureText').textContent).then(() => toast('ğŸ“‹')); }

    // æ‰“å¡
    function doCheckin() { const today = new Date().toDateString(); if (checkinData.lastDate === today) return toast('âœ…'); checkinData.streak = checkinData.lastDate === new Date(Date.now() - 86400000).toDateString() ? checkinData.streak + 1 : 1; checkinData.lastDate = today; checkinData.history.push(today); checkinData.points += 10; if (checkinData.streak % 7 === 0) checkinData.points += 50; updateCheckinUI(); saveData(); toast('âœ… +10'); }
    function updateCheckinUI() { document.getElementById('streakDays').textContent = checkinData.streak; document.getElementById('totalPoints').textContent = checkinData.points; document.getElementById('myPoints').textContent = checkinData.points; const btn = document.getElementById('checkinBtn'); btn.classList.toggle('done', checkinData.lastDate === new Date().toDateString()); renderCheckinCalendar(); }
    function renderCheckinCalendar() { const cal = document.getElementById('checkinCalendar'); const today = new Date(); const texts = I18N[currentLang]; const days = [texts.sunday, texts.monday, texts.tuesday, texts.wednesday, texts.thursday, texts.friday, texts.saturday]; let html = days.map(d => `<div style="text-align:center;font-size:8px;color:rgba(255,255,255,0.5);padding:2px;">${d}</div>`).join(''); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0); for (let i = 0; i < firstDay.getDay(); i++) html += '<div></div>'; for (let d = 1; d <= lastDay.getDate(); d++) { const date = new Date(today.getFullYear(), today.getMonth(), d).toDateString(); html += `<div style="text-align:center;padding:4px;font-size:9px;border-radius:4px;${checkinData.history.includes(date) ? 'background:var(--success);color:#000;' : ''}">${d}</div>`; } cal.innerHTML = html; }

    // æ¸²æŸ“
    function renderAll() { renderSounds(); renderClassics(); renderWater(); renderAdList(); renderFriends(); renderReminds(); renderUpcoming(); updateWaterUI(); }
    function renderSounds() { document.getElementById('soundList').innerHTML = SOUNDS.map(s => `<div class="sound-item ${s.id === currentSound ? 'active' : ''}" onclick="selectSound('${s.id}')">${s.name}</div>`).join(''); document.getElementById('tickSoundName').textContent = (SOUNDS.find(s => s.id === currentSound) || SOUNDS[0]).name.substring(2); }
    function selectSound(id) { currentSound = id; renderSounds(); saveData(); toast('âœ…'); }
    function setVolume(v) { volume = parseInt(v); saveData(); }

    // ==================== ç»å…¸ç³»ç»Ÿï¼ˆåŸç»ä¹¦ï¼‰ ====================
    const CLASSICS_DATA = {
        scriptures: [
            { icon: 'â˜¯ï¸', name: 'é“å¾·ç»', text: 'é“å¯é“ï¼Œéå¸¸é“ã€‚åå¯åï¼Œéå¸¸åã€‚æ— åï¼Œå¤©åœ°ä¹‹å§‹ï¼›æœ‰åï¼Œä¸‡ç‰©ä¹‹æ¯ã€‚æ•…å¸¸æ— æ¬²ï¼Œä»¥è§‚å…¶å¦™ï¼›å¸¸æœ‰æ¬²ï¼Œä»¥è§‚å…¶å¾¼ã€‚æ­¤ä¸¤è€…åŒå‡ºè€Œå¼‚åï¼ŒåŒè°“ä¹‹ç„ï¼Œç„ä¹‹åˆç„ï¼Œä¼—å¦™ä¹‹é—¨ã€‚' },
            { icon: 'ğŸ™', name: 'å¿ƒç»', text: 'è§‚è‡ªåœ¨è©è¨ï¼Œè¡Œæ·±èˆ¬è‹¥æ³¢ç½—èœœå¤šæ—¶ï¼Œç…§è§äº”è•´çš†ç©ºï¼Œåº¦ä¸€åˆ‡è‹¦å„ã€‚èˆåˆ©å­ï¼Œè‰²ä¸å¼‚ç©ºï¼Œç©ºä¸å¼‚è‰²ï¼Œè‰²å³æ˜¯ç©ºï¼Œç©ºå³æ˜¯è‰²ï¼Œå—æƒ³è¡Œè¯†äº¦å¤å¦‚æ˜¯ã€‚' },
            { icon: 'â˜°', name: 'æ˜“ç»', text: 'å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚åœ°åŠ¿å¤ï¼Œå›å­ä»¥åšå¾·è½½ç‰©ã€‚' },
            { icon: 'â˜ªï¸', name: 'å¤å…°ç»', text: 'å¥‰è‡³ä»è‡³æ…ˆçš„çœŸä¸»ä¹‹åï¼Œä¸€åˆ‡èµé¢‚å…¨å½’çœŸä¸»ï¼Œä¼—ä¸–ç•Œçš„ä¸»ï¼Œè‡³ä»è‡³æ…ˆçš„ä¸»ã€‚' },
            { icon: 'âœï¸', name: 'åœ£ç»', text: 'èµ·åˆï¼Œç¥åˆ›é€ å¤©åœ°ã€‚åœ°æ˜¯ç©ºè™šæ··æ²Œï¼Œæ¸Šé¢é»‘æš—ï¼›ç¥çš„çµè¿è¡Œåœ¨æ°´é¢ä¸Šã€‚ç¥è¯´ï¼šè¦æœ‰å…‰ï¼Œå°±æœ‰äº†å…‰ã€‚' }
        ],
        philosophy: [
            { icon: 'ğŸ“', name: 'è®ºè¯­', text: 'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ï¼Ÿæœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼Œä¸äº¦ä¹ä¹ï¼Ÿäººä¸çŸ¥è€Œä¸æ„ ï¼Œä¸äº¦å›å­ä¹ï¼Ÿ' },
            { icon: 'ğŸ“œ', name: 'å¤§å­¦', text: 'å¤§å­¦ä¹‹é“ï¼Œåœ¨æ˜æ˜å¾·ï¼Œåœ¨äº²æ°‘ï¼Œåœ¨æ­¢äºè‡³å–„ã€‚' },
            { icon: 'ğŸ›ï¸', name: 'ä¸­åº¸', text: 'å¤©å‘½ä¹‹è°“æ€§ï¼Œç‡æ€§ä¹‹è°“é“ï¼Œä¿®é“ä¹‹è°“æ•™ã€‚é“ä¹Ÿè€…ï¼Œä¸å¯é¡»è‡¾ç¦»ä¹Ÿã€‚' }
        ],
        poetry: [
            { icon: 'ğŸŒ™', name: 'é™å¤œæ€', text: 'åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚ä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚' },
            { icon: 'ğŸŒ¸', name: 'æ˜¥æ™“', text: 'æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚å¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚' },
            { icon: 'ğŸ”ï¸', name: 'ç™»é¹³é›€æ¥¼', text: 'ç™½æ—¥ä¾å±±å°½ï¼Œé»„æ²³å…¥æµ·æµã€‚æ¬²ç©·åƒé‡Œç›®ï¼Œæ›´ä¸Šä¸€å±‚æ¥¼ã€‚' }
        ],
        wisdom: [
            { icon: 'ğŸ’', name: 'èœæ ¹è°­', text: 'å® è¾±ä¸æƒŠï¼Œé—²çœ‹åº­å‰èŠ±å¼€èŠ±è½ï¼›å»ç•™æ— æ„ï¼Œæ¼«éšå¤©å¤–äº‘å·äº‘èˆ’ã€‚' },
            { icon: 'ğŸ‹', name: 'å›´ç‚‰å¤œè¯', text: 'å¤„ä¸–é¡»ç•™é€€æ­¥ï¼Œè¡Œäº‹é¡»è®©ä¸‰åˆ†ã€‚' },
            { icon: 'ğŸ“–', name: 'å°çª—å¹½è®°', text: 'é—­é—¨å³æ˜¯æ·±å±±ï¼Œè¯»ä¹¦éšå¤„å‡€åœŸã€‚' }
        ]
    };
    let currentClassicsTab = 'scriptures';

    function switchClassicsTab(tab) {
        currentClassicsTab = tab;
        document.querySelectorAll('#classicsTabs .water-tab').forEach((t, i) => {
            t.classList.toggle('active', ['scriptures','philosophy','poetry','wisdom'][i] === tab);
        });
        renderClassics();
    }

    function renderClassics() {
        const container = document.getElementById('classicsContent');
        if (!container) return;
        const items = CLASSICS_DATA[currentClassicsTab] || [];
        container.innerHTML = items.map(item => `
            <div class="item" onclick="speak('${item.text}');toast('â–¶ ${item.name}')">
                <div class="icon">${item.icon}</div>
                <div class="info">
                    <div class="name">${item.name}</div>
                    <div class="desc" style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px;">${item.text.substring(0,30)}...</div>
                </div>
                <div style="color:var(--primary)">â–¶</div>
            </div>
        `).join('');
    }

    // ==================== å–æ°´åŠŸèƒ½ï¼ˆæ ¸å¿ƒï¼‰ ====================
    function drinkWater(amount) {
        // æ£€æŸ¥æ˜¯å¦æ–°çš„ä¸€å¤©
        const today = new Date().toDateString();
        if (waterData.lastDate !== today) {
            waterData.today = 0;
            waterData.lastDate = today;
        }
        
        waterData.today += amount;
        waterData.history.push({ date: today, amount: amount, time: new Date().toLocaleTimeString() });
        
        saveData();
        updateWaterUI();
        
        // è¯­éŸ³åé¦ˆ
        const percent = Math.round((waterData.today / waterData.goal) * 100);
        if (waterData.today >= waterData.goal) {
            speak('å¤ªæ£’äº†ï¼ä»Šæ—¥é¥®æ°´ç›®æ ‡å·²è¾¾æˆï¼');
            toast('ğŸ‰ ç›®æ ‡è¾¾æˆï¼');
        } else {
            speak(`å·²å–${amount}æ¯«å‡ï¼Œä»Šæ—¥å…±${waterData.today}æ¯«å‡ï¼Œå®Œæˆ${percent}%`);
            toast(`ğŸ’§ +${amount}ml`);
        }
        
        // è§¦å‘åŠ¨ç”»
        const fill = document.getElementById('waterProgressFill');
        if (fill) {
            fill.style.transition = 'none';
            fill.style.transform = 'scaleX(1.05)';
            setTimeout(() => {
                fill.style.transition = 'all 0.5s ease';
                fill.style.transform = 'scaleX(1)';
            }, 100);
        }
    }

    function updateWaterUI() {
        // æ£€æŸ¥æ˜¯å¦æ–°çš„ä¸€å¤©
        const today = new Date().toDateString();
        if (waterData.lastDate !== today) {
            waterData.today = 0;
            waterData.lastDate = today;
        }
        
        const current = waterData.today;
        const goal = waterData.goal;
        const percent = Math.min(100, Math.round((current / goal) * 100));
        
        const currentEl = document.getElementById('waterCurrent');
        const percentEl = document.getElementById('waterPercent');
        const fillEl = document.getElementById('waterProgressFill');
        
        if (currentEl) currentEl.textContent = current;
        if (percentEl) percentEl.textContent = percent + '%';
        if (fillEl) fillEl.style.width = percent + '%';
        
        // æ›´æ–°æ—¶é—´è¡¨
        updateWaterSchedule();
    }

    function updateWaterSchedule() {
        const now = new Date();
        const currentHour = now.getHours();
        const scheduleEl = document.getElementById('waterSchedule');
        if (!scheduleEl) return;
        
        const times = [
            { hour: 7, icon: 'â˜€ï¸', label: '7:00' },
            { hour: 9, icon: 'ğŸŒ¤ï¸', label: '9:00' },
            { hour: 11, icon: 'â˜€ï¸', label: '11:00' },
            { hour: 13, icon: 'ğŸš', label: '13:00' },
            { hour: 15, icon: 'ğŸŒ¤ï¸', label: '15:00' },
            { hour: 17, icon: 'ğŸŒ…', label: '17:00' },
            { hour: 19, icon: 'ğŸŒ™', label: '19:00' },
            { hour: 21, icon: 'ğŸ˜´', label: '21:00' }
        ];
        
        scheduleEl.innerHTML = times.map(t => {
            let cls = 'schedule-item';
            if (currentHour > t.hour) cls += ' done';
            else if (currentHour >= t.hour - 1 && currentHour <= t.hour) cls += ' active';
            return `<span class="${cls}">${t.icon} ${t.label}</span>`;
        }).join('');
    }

    // æ°´å­¦äºŒçº§ç›®å½•
    function openWaterSection(section) {
        const contents = {
            institute: { title: 'ğŸ›ï¸ æ°´å­¦ç ”ç©¶é™¢', desc: 'æ°´è‹¥å–„å…ˆç”Ÿåˆ›ç«‹çš„æ°´å­¦ç ”ç©¶æœºæ„ï¼Œè‡´åŠ›äºæ°´ç§‘å­¦ã€æ°´å“²å­¦ã€æ°´å¥åº·ã€æ°´åŒ»å­¦çš„ç ”ç©¶ä¸ä¼ æ’­ã€‚å·²å‡ºç‰ˆ2000ä¸‡å­—å­¦æœ¯è‘—ä½œã€‚', items: ['æ°´å­¦æ¦‚è®º', 'æ°´ä¸ç”Ÿå‘½', 'æ°´çš„å“²ç†', 'æ°´ç–—å…»ç”Ÿ'] },
            tech: { title: 'ğŸ”§ æ°´ç§‘æŠ€', desc: 'å°†æ°´å­¦ç†è®ºåº”ç”¨äºç§‘æŠ€åˆ›æ–°ï¼ŒåŒ…æ‹¬æ°´å¤„ç†æŠ€æœ¯ã€èŠ‚æ°´æŠ€æœ¯ã€æ°´è´¨æ£€æµ‹ã€æ™ºèƒ½é¥®æ°´ç³»ç»Ÿç­‰ã€‚', items: ['æ™ºèƒ½æ°´æ¯', 'å‡€æ°´æŠ€æœ¯', 'èŠ‚æ°´æ–¹æ¡ˆ', 'æ°´è´¨ç›‘æµ‹'] },
            products: { title: 'ğŸ›’ æ°´äº§å“', desc: 'åŸºäºæ°´å­¦ç†è®ºç ”å‘çš„å¥åº·äº§å“ï¼ŒåŒ…æ‹¬åŠŸèƒ½æ€§é¥®ç”¨æ°´ã€æ°´ç–—äº§å“ã€å…»ç”Ÿå™¨å…·ç­‰ã€‚', items: ['æ´»æ€§æ°´', 'çŸ¿æ³‰æ°´', 'æ°´ç–—ä»ª', 'å…»ç”Ÿå£¶'] },
            inventions: { title: 'ğŸ’¡ æ°´å‘æ˜', desc: 'æ°´è‹¥å–„å…ˆç”Ÿçš„ä¸“åˆ©å‘æ˜ï¼ŒåŒ…æ‹¬æ°´å¤„ç†è®¾å¤‡ã€å¥åº·é¥®æ°´è£…ç½®ã€æ°´ç–—å™¨æ¢°ç­‰åˆ›æ–°æˆæœã€‚', items: ['ä¸“åˆ©ä¸€è§ˆ', 'å‘æ˜æ•…äº‹', 'æŠ€æœ¯åŸç†', 'åº”ç”¨æ¡ˆä¾‹'] }
        };
        const data = contents[section];
        if (!data) return;
        
        const html = `
            <div style="padding:15px;background:rgba(0,188,212,0.1);border-radius:12px;margin-top:10px;">
                <div style="font-size:16px;font-weight:bold;color:var(--water);margin-bottom:8px;">${data.title}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.7);line-height:1.6;margin-bottom:12px;">${data.desc}</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    ${data.items.map(item => `<div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:11px;text-align:center;cursor:pointer;" onclick="toast('å³å°†æ¨å‡ºï¼š${item}')">${item}</div>`).join('')}
                </div>
            </div>
        `;
        
        // æ˜¾ç¤ºåœ¨æ°´å­¦é¢æ¿åº•éƒ¨
        let container = document.getElementById('waterSectionContent');
        if (!container) {
            container = document.createElement('div');
            container.id = 'waterSectionContent';
            document.getElementById('waterPanel').appendChild(container);
        }
        container.innerHTML = html;
    }

    // ä¼šå‘˜å‡çº§
    function upgradePlan(plan) {
        const prices = { monthly: 'Â¥9.99/æœˆ', quarterly: 'Â¥19.99/å­£', yearly: 'Â¥199/å¹´', enterprise: 'Â¥9999/å¹´' };
        const names = { monthly: 'æœˆåº¦ä¼šå‘˜', quarterly: 'å­£åº¦ä¼šå‘˜', yearly: 'å¹´åº¦VIP', enterprise: 'ä¼ä¸šç‰ˆ' };
        
        if (plan === 'enterprise') {
            toast('ğŸ“ ä¼ä¸šç‰ˆè¯·è”ç³»å®¢æœ');
            return;
        }
        
        if (confirm(`ç¡®è®¤å‡çº§ä¸º${names[plan]}ï¼ˆ${prices[plan]}ï¼‰ï¼Ÿ`)) {
            if (!user) {
                toast('è¯·å…ˆç™»å½•');
                return;
            }
            user.level = plan === 'yearly' ? 'vip' : plan;
            const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
            users[user.phone] = user;
            localStorage.setItem('heshuileUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(user));
            updateUI();
            updateMembershipUI();
            toast('ğŸ‘‘ å‡çº§æˆåŠŸï¼');
            speak('æ­å–œæ‚¨å‡çº§æˆåŠŸï¼');
        }
    }

    function updateMembershipUI() {
        if (!user) return;
        const levelNames = { free: 'ğŸ†“ å…è´¹ç”¨æˆ·', monthly: 'â­ æœˆåº¦ä¼šå‘˜', quarterly: 'ğŸŒŸ å­£åº¦ä¼šå‘˜', vip: 'ğŸ‘‘ å¹´åº¦VIP', enterprise: 'ğŸ¢ ä¼ä¸šç‰ˆ' };
        const titleEl = document.getElementById('membershipTitle');
        const limitsEl = document.getElementById('membershipLimits');
        
        if (titleEl) titleEl.textContent = levelNames[user.level] || levelNames.free;
        
        const limits = {
            free: 'â€¢ æé†’æ•°é‡ï¼šæ¯å¤©10æ¡<br>â€¢ ç²¾ç¡®åº¦ï¼šåˆ†é’Ÿçº§<br>â€¢ å…³æ€€å¯¹è±¡ï¼š3äºº<br>â€¢ ä¸»é¢˜é£æ ¼ï¼š2æ¬¾<br>â€¢ ç»å…¸/æ°´å­¦ï¼šæ¯æ—¥1ç¯‡<br>â€¢ å¹¿å‘Šï¼šæœ‰å¹¿å‘Š',
            monthly: 'â€¢ æé†’æ•°é‡ï¼šæ— é™åˆ¶<br>â€¢ ç²¾ç¡®åº¦ï¼šç§’çº§ç²¾ç¡®<br>â€¢ å…³æ€€å¯¹è±¡ï¼šæ— é™åˆ¶<br>â€¢ ä¸»é¢˜é£æ ¼ï¼šå…¨4æ¬¾<br>â€¢ ç»å…¸/æ°´å­¦ï¼šå…¨éƒ¨å†…å®¹<br>â€¢ å¹¿å‘Šï¼šæ— å¹¿å‘Š',
            quarterly: 'â€¢ æé†’æ•°é‡ï¼šæ— é™åˆ¶<br>â€¢ ç²¾ç¡®åº¦ï¼šç§’çº§ç²¾ç¡®<br>â€¢ å…³æ€€å¯¹è±¡ï¼šæ— é™åˆ¶<br>â€¢ ä¸»é¢˜é£æ ¼ï¼šå…¨4æ¬¾+è‡ªå®šä¹‰<br>â€¢ ç»å…¸/æ°´å­¦ï¼šå…¨éƒ¨å†…å®¹+éŸ³é¢‘<br>â€¢ å¹¿å‘Šï¼šæ— å¹¿å‘Š',
            vip: 'â€¢ æé†’æ•°é‡ï¼šæ— é™åˆ¶<br>â€¢ ç²¾ç¡®åº¦ï¼šç§’çº§ç²¾ç¡®<br>â€¢ å…³æ€€å¯¹è±¡ï¼šæ— é™åˆ¶<br>â€¢ ä¸»é¢˜é£æ ¼ï¼šå…¨4æ¬¾+è‡ªå®šä¹‰<br>â€¢ ç»å…¸/æ°´å­¦ï¼šå…¨éƒ¨å†…å®¹+éŸ³é¢‘<br>â€¢ å¹¿å‘Šï¼šæ— å¹¿å‘Š<br>â€¢ ä¸“å±å®¢æœæ”¯æŒ',
            enterprise: 'â€¢ æé†’æ•°é‡ï¼šæ— é™åˆ¶+åˆ†ç»„ç®¡ç†<br>â€¢ ç²¾ç¡®åº¦ï¼šç§’çº§+è‡ªå®šä¹‰æå‰é‡<br>â€¢ å…³æ€€å¯¹è±¡ï¼šæ— é™+åˆ†ç»„<br>â€¢ ä¸»é¢˜é£æ ¼ï¼šå“ç‰Œå®šåˆ¶<br>â€¢ ç»å…¸/æ°´å­¦ï¼šä¼ä¸šä¸“å±å†…å®¹<br>â€¢ å¹¿å‘Šï¼šå“ç‰Œå¹¿å‘Šä½'
        };
        if (limitsEl) limitsEl.innerHTML = limits[user.level] || limits.free;
    }
    // ==================== æ°´å­¦è¯¾ç¨‹ç³»ç»Ÿ ====================
    const WATER_LESSONS = {
        science: [
            { title: 'ç¬¬1è¯¾ï¼šæ°´åˆ†å­çš„ç§˜å¯†', text: 'æ°´åˆ†å­ç”±ä¸¤ä¸ªæ°¢åŸå­å’Œä¸€ä¸ªæ°§åŸå­ç»„æˆï¼Œå½¢æˆ104.5åº¦çš„å¤¹è§’ã€‚è¿™ä¸ªè§’åº¦èµ‹äºˆäº†æ°´ç‹¬ç‰¹çš„ææ€§ï¼Œä½¿å®ƒæˆä¸º"ä¸‡èƒ½æº¶å‰‚"ã€‚ä¸€æ»´æ°´ä¸­çº¦å«æœ‰1.67Ã—10Â²Â¹ä¸ªæ°´åˆ†å­ï¼Œæ¯”å®‡å®™ä¸­çš„æ’æ˜Ÿè¿˜è¦å¤šã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬ä¸€ç« ' },
            { title: 'ç¬¬2è¯¾ï¼šæ°´çš„ä¸‰æ€å¥‡è¿¹', text: 'æ°´æ˜¯å”¯ä¸€åœ¨è‡ªç„¶ç•Œä»¥å›ºæ€ã€æ¶²æ€ã€æ°”æ€ä¸‰ç§å½¢å¼å­˜åœ¨çš„ç‰©è´¨ã€‚å†°çš„å¯†åº¦æ¯”æ¶²æ€æ°´å°ï¼Œæ‰€ä»¥å†°èƒ½æµ®åœ¨æ°´é¢ï¼Œä¿æŠ¤äº†æ°´ä¸‹ç”Ÿç‰©åœ¨å¯’å†¬ä¸­å­˜æ´»ã€‚æ°´åœ¨4â„ƒæ—¶å¯†åº¦æœ€å¤§ï¼Œè¿™ä¸€ç‰¹æ€§å¯¹æ¹–æ³Šç”Ÿæ€è‡³å…³é‡è¦ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬äºŒç« ' },
            { title: 'ç¬¬3è¯¾ï¼šæ°´çš„è®°å¿†', text: 'æ°´çš„æ¯”çƒ­å®¹æ˜¯æ‰€æœ‰å¸¸è§ç‰©è´¨ä¸­æœ€é«˜çš„ï¼Œè¿™ä½¿æ°´èƒ½å¤Ÿè°ƒèŠ‚åœ°çƒæ¸©åº¦ï¼Œç¨³å®šæ°”å€™ã€‚æ°´çš„è¡¨é¢å¼ åŠ›å¾ˆå¼ºï¼Œä½¿å°æ˜†è™«èƒ½åœ¨æ°´é¢è¡Œèµ°ï¼Œæ¤ç‰©èƒ½å°†æ°´ä»æ ¹éƒ¨è¾“é€åˆ°é¡¶ç«¯ã€‚çº¯å‡€æ°´æ˜¯æå¥½çš„æº¶å‰‚ï¼Œèƒ½æº¶è§£æ¯”ä»»ä½•å…¶ä»–æ¶²ä½“æ›´å¤šçš„ç‰©è´¨ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬ä¸‰ç« ' },
            { title: 'ç¬¬4è¯¾ï¼šåœ°çƒçš„è¡€æ¶²', text: 'åœ°çƒä¸Šçš„æ°´æ€»é‡çº¦14äº¿ç«‹æ–¹åƒç±³ï¼Œä½†æ·¡æ°´ä»…å 2.5%ï¼Œå¯ç›´æ¥åˆ©ç”¨çš„æ›´ä¸åˆ°1%ã€‚æ°´å¾ªç¯æ˜¯åœ°çƒæœ€ä¼Ÿå¤§çš„å¾ªç¯ç³»ç»Ÿâ€”â€”è’¸å‘ã€å‡ç»“ã€é™æ°´ã€æ¸—æµï¼Œæ¯ä¸€æ»´æ°´éƒ½åœ¨æ°¸æ’åœ°æ—…è¡Œã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬å››ç« ' }
        ],
        philosophy: [
            { title: 'ç¬¬1è¯¾ï¼šä¸Šå–„è‹¥æ°´', text: 'è€å­ã€Šé“å¾·ç»ã€‹äº‘ï¼š"ä¸Šå–„è‹¥æ°´ï¼Œæ°´å–„åˆ©ä¸‡ç‰©è€Œä¸äº‰ï¼Œå¤„ä¼—äººä¹‹æ‰€æ¶ï¼Œæ•…å‡ äºé“ã€‚"æ°´çš„å“å¾·æ˜¯æ— ç§å¥‰çŒ®ã€æ»‹å…»ä¸‡ç‰©ï¼Œå´ä»ä¸è‡ªå¤¸ã€‚æ°´å¾€ä½å¤„æµï¼Œæ­£å¦‚è°¦å‘çš„æ™ºè€…ã€‚åšäººå½“å­¦æ°´ï¼Œåˆ©ä»–ä¸äº‰ï¼Œå¤„ä¸‹ä¸å‘ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬ä¸€ç« ' },
            { title: 'ç¬¬2è¯¾ï¼šæ°´çš„æŸ”ä¸åˆš', text: 'æ°´è‡³æŸ”å´èƒ½ç©¿çŸ³ï¼Œè‡³å¼±å´èƒ½è½½èˆŸã€‚æ°´çš„åŠ›é‡ä¸åœ¨äºå¯¹æŠ—ï¼Œè€Œåœ¨äºé¡ºåŠ¿è€Œä¸ºã€æŒä¹‹ä»¥æ’ã€‚å¤©ä¸‹è«æŸ”å¼±äºæ°´ï¼Œè€Œæ”»åšå¼ºè€…è«ä¹‹èƒ½èƒœã€‚è¿™å‘Šè¯‰æˆ‘ä»¬ï¼šä»¥æŸ”å…‹åˆšï¼ŒåšæŒä¸æ‡ˆï¼Œç»ˆèƒ½æˆå°±å¤§äº‹ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬äºŒç« ' },
            { title: 'ç¬¬3è¯¾ï¼šæ°´çš„æ™ºæ…§', text: 'æ°´æ— å¸¸å½¢ï¼Œéšå™¨è€Œå˜ï¼›æ°´æ— å¸¸æ€ï¼Œå› æ¸©è€ŒåŒ–ã€‚æ°´æ•™ä¼šæˆ‘ä»¬é€‚åº”ç¯å¢ƒã€çµæ´»å˜é€šã€‚ä¸å›ºæ‰§å·±è§ï¼Œä¸å¼ºæ±‚ç»“æœï¼Œé¡ºå…¶è‡ªç„¶ï¼Œæ–¹èƒ½æµ·çº³ç™¾å·ã€‚å­”å­æ›°ï¼š"æ™ºè€…ä¹æ°´"ï¼Œæ°´çš„æ™ºæ…§åœ¨äºåŒ…å®¹ä¸å˜é€šã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬ä¸‰ç« ' },
            { title: 'ç¬¬4è¯¾ï¼šæ°´ä¸æ—¶é—´', text: 'æ°´æ»´çŸ³ç©¿ï¼Œéä¸€æ—¥ä¹‹åŠŸï¼›å†°å†»ä¸‰å°ºï¼Œéä¸€æ—¥ä¹‹å¯’ã€‚æ°´æ•™ä¼šæˆ‘ä»¬æ—¶é—´çš„åŠ›é‡ã€‚æ­£å¦‚ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€â€”â€”æ¯ä¸€ç§’çš„åšæŒï¼Œéƒ½æ˜¯æ°´æ»´ç©¿çŸ³çš„åŠ›é‡ã€‚çæƒœæ—¶é—´ï¼Œå°±æ˜¯çæƒœç”Ÿå‘½ä¸­çš„æ¯ä¸€æ»´æ°´ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬å››ç« ' }
        ],
        health: [
            { title: 'ç¬¬1è¯¾ï¼šæ™¨èµ·ä¸€æ¯æ°´', text: 'æ—©æ™¨èµ·åºŠåï¼Œç©ºè…¹å–ä¸€æ¯æ¸©æ°´ï¼Œå¯ä»¥å”¤é†’è‚ èƒƒã€ç¨€é‡Šè¡€æ¶²ã€ä¿ƒè¿›æ’æ¯’ã€‚æœ€ä½³æ°´æ¸©ä¸º35-40åº¦ï¼Œå¯ä»¥åŠ å…¥å°‘è®¸èœ‚èœœæˆ–æŸ æª¬ã€‚è¿™æ˜¯å¼€å¯å¥åº·ä¸€å¤©çš„æœ€ä½³æ–¹å¼ã€‚ä¸­åŒ»è®¤ä¸ºæ™¨æ°´å…»é˜³ï¼Œæ¶¦æ³½äº”è„ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬ä¸€ç« ' },
            { title: 'ç¬¬2è¯¾ï¼šé¥®æ°´ä¸æ’æ¯’', text: 'äººä½“çº¦70%æ˜¯æ°´ï¼Œå¤§è„‘å«æ°´é‡é«˜è¾¾80%ã€‚æ¯å¤©å–è¶³å¤Ÿçš„æ°´å¯ä»¥å¸®åŠ©æ’å‡ºä½“å†…æ¯’ç´ ï¼Œç»´æŒè‚¾è„å¥åº·ï¼Œé¢„é˜²è‚¾ç»“çŸ³ã€‚æ¯å¤©åº”é¥®ç”¨2000-3000æ¯«å‡æ°´ï¼Œå°‘é‡å¤šæ¬¡ä¸ºå®œã€‚è„±æ°´2%å°±èƒ½é™ä½æ³¨æ„åŠ›å’Œè®°å¿†åŠ›ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬äºŒç« ' },
            { title: 'ç¬¬3è¯¾ï¼šæ°´ç–—çš„æ™ºæ…§', text: 'æ°´ç–—æ³•æºè¿œæµé•¿ï¼Œå¤å¸Œè…Šçš„å¸Œæ³¢å…‹æ‹‰åº•å°±æå€¡ç”¨æ°´æ²»ç—…ã€‚çƒ­æ°´å¯ä»¥ä¿ƒè¿›è¡€æ¶²å¾ªç¯ï¼Œå†·æ°´å¯ä»¥å¢å¼ºå…ç–«åŠ›ï¼Œäº¤æ›¿ä½¿ç”¨æ•ˆæœæ›´ä½³ã€‚æ¸©æ³‰æµ´å¯ä»¥ç¼“è§£å…³èŠ‚ç–¼ç—›ï¼Œæ˜¯è‡ªç„¶ç•Œèµäºˆäººç±»çš„è‰¯è¯ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬ä¸‰ç« ' },
            { title: 'ç¬¬4è¯¾ï¼šæ°´ä¸ç»ç»œ', text: 'ä¸­åŒ»è®¤ä¸ºï¼Œæ°´æ¶²åœ¨ä½“å†…çš„è¿è¡Œä¸ç»ç»œå¯†åˆ‡ç›¸å…³ã€‚ä¸‰ç„¦æ˜¯æ°´æ¶²ä»£è°¢çš„é€šé“ï¼Œè†€èƒ±ç»ä¸»ç®¡æ°´æ¶²çš„æ’æ³„ã€‚é€šè¿‡é’ˆç¸ã€æŒ‰æ‘©ç›¸å…³ç©´ä½ï¼Œå¯ä»¥è°ƒèŠ‚æ°´æ¶²ä»£è°¢ï¼Œæ²»ç–—æ°´è‚¿ç­‰ç–¾ç—…ã€‚é¥®æ°´å…»ç”Ÿï¼Œä¸å¯å¿½è§†ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬å››ç« ' }
        ]
    };

    // è‹æ ¼æ‹‰åº•å¯¹è¯æ ‘
    const SOCRATIC_TREE = [
        { id: 0, role: 'master', text: 'æ¬¢è¿æ¥åˆ°æ°´çš„æ™ºæ…§æ®¿å ‚ã€‚æˆ‘æ˜¯ä½ çš„æ°´å­¦å¯¼å¸ˆã€‚è®©æˆ‘ä»¬é€šè¿‡å¯¹è¯æ¥æ¢ç´¢æ°´çš„å¥¥ç§˜ã€‚è¯·é—®â€”â€”ä½ è®¤ä¸ºï¼Œæ°´æœ€é‡è¦çš„å“è´¨æ˜¯ä»€ä¹ˆï¼Ÿ',
          options: [
            { text: 'æˆ‘è§‰å¾—æ˜¯æ°´çš„æŸ”è½¯å’ŒåŒ…å®¹', next: 1 },
            { text: 'åº”è¯¥æ˜¯æ°´èƒ½æ»‹å…»ä¸‡ç‰©çš„èƒ½åŠ›', next: 2 },
            { text: 'æ°´èƒ½ä»¥æŸ”å…‹åˆšï¼Œçœ‹ä¼¼å¼±å®åˆ™å¼º', next: 3 }
          ]
        },
        { id: 1, role: 'master', text: 'å¾ˆå¥½çš„è§‚å¯Ÿï¼è€å­è¯´"ä¸Šå–„è‹¥æ°´"ã€‚æ°´ç¡®å®è‡³æŸ”è‡³é¡ºã€‚ä½†ä½ æ˜¯å¦æƒ³è¿‡â€”â€”æ°´çš„æŸ”è½¯æ°æ°æ˜¯å®ƒæœ€å¤§çš„åŠ›é‡ï¼Ÿè¯•æƒ³ï¼Œæ°´æ»´ä¸ºä½•èƒ½ç©¿çŸ³ï¼Ÿ',
          options: [
            { text: 'å› ä¸ºæ°´æŒä¹‹ä»¥æ’ï¼Œä»ä¸æ”¾å¼ƒ', next: 4 },
            { text: 'å› ä¸ºæ°´ä¸ä¸çŸ³å¤´ç¡¬ç¢°ç¡¬ï¼Œè€Œæ˜¯æ‰¾åˆ°ç¼éš™', next: 5 }
          ]
        },
        { id: 2, role: 'master', text: 'è¯´å¾—å¥½ï¼æ°´æ»‹å…»ä¸‡ç‰©å´ä¸äº‰åŠŸã€‚ä¸–é—´è¿˜æœ‰ä»€ä¹ˆæ¯”è¿™æ›´æ¥è¿‘"é“"å‘¢ï¼Ÿé‚£ä¹ˆæˆ‘é—®ä½ â€”â€”å¦‚æœæ°´åªæ»‹å…»è€Œä»ä¸ç´¢å–ï¼Œå®ƒä¼šæ¯ç«­å—ï¼Ÿ',
          options: [
            { text: 'ä¸ä¼šï¼Œå› ä¸ºæ°´æœ‰å¾ªç¯â€”â€”è’¸å‘ååˆä¼šå›æ¥', next: 6 },
            { text: 'ä¼šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦çæƒœæ°´èµ„æº', next: 7 }
          ]
        },
        { id: 3, role: 'master', text: 'å¥½ä¸€ä¸ª"ä»¥æŸ”å…‹åˆš"ï¼ã€Šé“å¾·ç»ã€‹äº‘ï¼š"å¤©ä¸‹è«æŸ”å¼±äºæ°´ï¼Œè€Œæ”»åšå¼ºè€…è«ä¹‹èƒ½èƒœã€‚"ä½ è§‰å¾—è¿™ä¸ªé“ç†å¯ä»¥ç”¨åœ¨ç”Ÿæ´»ä¸­çš„ä»€ä¹ˆåœ°æ–¹ï¼Ÿ',
          options: [
            { text: 'é¢å¯¹å›°éš¾æ—¶ï¼Œä¸è¦ç¡¬æ’‘ï¼Œè¦å­¦ä¼šå˜é€š', next: 8 },
            { text: 'ä¸äººç›¸å¤„æ—¶ï¼Œæ¸©å’Œæ¯”å¼ºç¡¬æ›´æœ‰åŠ›é‡', next: 9 }
          ]
        },
        { id: 4, role: 'master', text: 'æ­£æ˜¯å¦‚æ­¤ï¼åšæŒï¼Œæ˜¯æ—¶é—´èµ‹äºˆæ°´çš„æ­¦å™¨ã€‚æ­£å¦‚æˆ‘ä»¬è¯´ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€â€”â€”æ¯ä¸€ç§’çš„åšæŒéƒ½æ˜¯ä¸€æ»´æ°´ï¼Œç»ˆå°†ç©¿é€ä¸€åˆ‡é˜»ç¢ã€‚ä½ ç°åœ¨æ˜ç™½æ—¶é—´ä¸æ°´çš„å…³ç³»äº†å—ï¼Ÿ',
          options: [
            { text: 'æ˜ç™½äº†ï¼æ¯ä¸€ç§’éƒ½åƒä¸€æ»´æ°´ï¼Œç§¯å°‘æˆå¤š', next: 10 },
            { text: 'æˆ‘æƒ³ç»§ç»­æ¢ç´¢æ°´çš„å…¶ä»–æ™ºæ…§', next: 11 }
          ]
        },
        { id: 5, role: 'master', text: 'å¦™å“‰ï¼æ°´ä»ä¸æ­£é¢å¯¹æŠ—ï¼Œå®ƒæ€»æ˜¯æ‰¾åˆ°æœ€ä¼˜è·¯å¾„ã€‚å±±æŒ¡ä¸ä½æ°´ï¼ŒçŸ³æ‹¦ä¸ä½æ²³ã€‚æ°´æ•™ä¼šæˆ‘ä»¬ï¼šé‡åˆ°éšœç¢ä¸è¦ç¡¬ç¢°ï¼Œç»•è¿‡å»ï¼Œæˆ–è€…æ…¢æ…¢æ¸—é€ã€‚',
          options: [
            { text: 'è¿™å°±æ˜¯"é¡ºåŠ¿è€Œä¸º"çš„æ™ºæ…§', next: 10 },
            { text: 'æ°´è¿˜æœ‰ä»€ä¹ˆäººç”Ÿæ™ºæ…§ï¼Ÿ', next: 11 }
          ]
        },
        { id: 6, role: 'master', text: 'ç²¾å½©ï¼ä½ å‘ç°äº†æ°´å¾ªç¯çš„æ·±å±‚æ™ºæ…§ã€‚ç»™äºˆå¹¶ä¸æ„å‘³ç€å¤±å»â€”â€”æ°´è’¸å‘åˆ°å¤©ç©ºï¼ŒåŒ–ä¸ºé›¨éœ²é‡è¿”å¤§åœ°ã€‚å–„è¡Œå¦‚æ°´ï¼Œç»ˆå°†å›åˆ°è‡ªå·±èº«è¾¹ã€‚è¿™å°±æ˜¯"ä¸Šå–„è‹¥æ°´"çš„å®Œæ•´å«ä¹‰ã€‚',
          options: [
            { text: 'åŸæ¥"å–„"ä¹Ÿæœ‰å¾ªç¯ï¼Œä»˜å‡ºç»ˆæœ‰å›æŠ¥', next: 10 },
            { text: 'æˆ‘è¿˜æƒ³äº†è§£æ›´å¤š', next: 11 }
          ]
        },
        { id: 7, role: 'master', text: 'çæƒœï¼Œæ˜¯æ™ºæ…§çš„å¼€ç«¯ã€‚æ­£å¦‚çæƒœæ—¶é—´ä¸€æ ·ï¼Œæ¯ä¸€æ»´æ°´ã€æ¯ä¸€ç§’é’Ÿéƒ½å€¼å¾—æ•¬ç•ã€‚ã€Œåˆ†ç§’å¿…äº‰ã€ä¸ä»…æ˜¯å¯¹æ—¶é—´çš„æ€åº¦ï¼Œä¹Ÿæ˜¯å¯¹ç”Ÿå‘½ä¸­ä¸€åˆ‡çè´µäº‹ç‰©çš„æ€åº¦ã€‚',
          options: [
            { text: 'æˆ‘ç†è§£äº†ï¼Œçæƒœæ—¶é—´å°±æ˜¯çæƒœç”Ÿå‘½', next: 10 },
            { text: 'ç»§ç»­å­¦ä¹ æ°´çš„é“ç†', next: 11 }
          ]
        },
        { id: 8, role: 'master', text: 'å¯¹ï¼æ°´é‡åˆ°çŸ³å¤´ä¸ä¼šåœä¸‹ï¼Œè€Œæ˜¯æ”¹å˜æ–¹å‘ç»§ç»­æµåŠ¨ã€‚è¿™å°±æ˜¯"æ°´çš„å˜é€š"â€”â€”ä¸æ‰§ç€äºå½¢å¼ï¼Œåªæ‰§ç€äºç›®æ ‡ã€‚ç”Ÿæ´»ä¸­é‡åˆ°æŒ«æŠ˜ï¼Œæ¢æ¡è·¯èµ°ï¼Œä¾ç„¶èƒ½åˆ°è¾¾å¤§æµ·ã€‚',
          options: [{ text: 'å—æ•™äº†ï¼Œè°¢è°¢å¯¼å¸ˆçš„æŒ‡ç‚¹', next: 10 }]
        },
        { id: 9, role: 'master', text: 'å­”å­è¯´"æ™ºè€…ä¹æ°´"ã€‚æ¸©å’Œçš„æ°´çœ‹ä¼¼æ— åŠ›ï¼Œå´èƒ½æ„ŸåŒ–åšç¡¬çš„çŸ³å¤´ã€‚ä¸äººç›¸å¤„ï¼Œæ¸©æ¶¦å¦‚æ°´æ¯”é”‹åˆ©å¦‚åˆ€æ›´èƒ½èµ¢å¾—äººå¿ƒã€‚è¿™å°±æ˜¯æ°´çš„æ™ºæ…§â€”â€”åˆ©ä»–è€Œä¸äº‰ã€‚',
          options: [{ text: 'æ¸©æ¶¦å¦‚æ°´ï¼Œåˆ©ä»–ä¸äº‰ï¼Œæˆ‘è®°ä½äº†', next: 10 }]
        },
        { id: 10, role: 'master', text: 'ğŸ“ æ­å–œä½ å®Œæˆäº†è¿™æ®µæ°´çš„æ™ºæ…§å¯¹è¯ï¼è®°ä½ï¼šåƒæ°´ä¸€æ ·æŸ”è½¯ï¼Œåƒæ°´ä¸€æ ·åšæŒï¼Œåƒæ°´ä¸€æ ·åŒ…å®¹ã€‚çæƒœæ¯ä¸€ç§’ï¼Œå¦‚åŒçæƒœæ¯ä¸€æ»´æ°´ã€‚ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€â€”â€”æ„¿ä½ çš„äººç”Ÿå¦‚æ°´èˆ¬ä¸°ç›ˆã€‚',
          options: [{ text: 'ğŸ”„ é‡æ–°å¼€å§‹å¯¹è¯', next: 0 }, { text: 'ğŸ”Š æœ—è¯»æ€»ç»“', next: -1 }]
        },
        { id: 11, role: 'master', text: 'æ°´è¿˜æœ‰ä¸€ä¸ªé‡è¦å“è´¨â€”â€”åŒ…å®¹ã€‚å¤§æµ·ä¸ºä½•èƒ½æˆä¸ºç™¾å·ä¹‹ç‹ï¼Ÿå› ä¸ºå®ƒå¤„äºæœ€ä½å¤„ï¼Œä¸æ‹’ç»ä»»ä½•ä¸€æ¡æ²³æµã€‚è¶Šæ˜¯ä¼Ÿå¤§çš„äººï¼Œè¶Šæ˜¯è°¦é€ŠåŒ…å®¹ã€‚ä½ è§‰å¾—è‡ªå·±åœ¨ç”Ÿæ´»ä¸­å¤Ÿ"åŒ…å®¹"å—ï¼Ÿ',
          options: [
            { text: 'æœ‰æ—¶å€™åšä¸åˆ°ï¼Œä½†æˆ‘æ„¿æ„å­¦ä¹ ', next: 10 },
            { text: 'åŒ…å®¹å¾ˆéš¾ï¼Œä½†æ°´ç»™äº†æˆ‘å¯å‘', next: 10 }
          ]
        }
    ];

    let currentWaterCategory = 'science';
    let currentWaterIndex = 0;
    let socraticNode = 0;

    function switchWaterTab(tab) {
        currentWaterCategory = tab;
        currentWaterIndex = 0;
        document.querySelectorAll('.water-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        const lessonArea = document.getElementById('waterLessonContent');
        const socraticArea = document.getElementById('socraticSection');
        if (tab === 'socratic') {
            lessonArea.style.display = 'none';
            socraticArea.style.display = 'block';
            startSocratic();
        } else {
            lessonArea.style.display = 'block';
            socraticArea.style.display = 'none';
            renderWaterLesson();
        }
    }

    function renderWaterLesson() {
        const lessons = WATER_LESSONS[currentWaterCategory] || WATER_LESSONS.science;
        const lesson = lessons[currentWaterIndex] || lessons[0];
        document.getElementById('waterLessonContent').innerHTML = `<div class="water-lesson"><div class="title">${lesson.title}</div><div class="text">${lesson.text}</div><div class="source">â€” ${lesson.source}</div></div><div style="text-align:center;font-size:9px;color:rgba(255,255,255,0.4);">${currentWaterIndex + 1} / ${lessons.length}</div>`;
    }

    function prevWaterLesson() { const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return; currentWaterIndex = (currentWaterIndex - 1 + lessons.length) % lessons.length; renderWaterLesson(); }
    function nextWaterLesson() { const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return; currentWaterIndex = (currentWaterIndex + 1) % lessons.length; renderWaterLesson(); }
    function speakWaterLesson() {
        if (currentWaterCategory === 'socratic') { speak('æ°´çš„è‹æ ¼æ‹‰åº•å¯¹è¯æ­£åœ¨è¿›è¡Œä¸­'); return; }
        const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return;
        const lesson = lessons[currentWaterIndex];
        speak(lesson.title + 'ã€‚' + lesson.text);
        toast('ğŸ”Š æ­£åœ¨æœ—è¯»...');
    }

    // è‹æ ¼æ‹‰åº•å¯¹è¯
    function startSocratic() {
        socraticNode = 0;
        document.getElementById('socraticChat').innerHTML = '';
        renderSocraticNode(0);
    }

    function renderSocraticNode(nodeId) {
        if (nodeId === -1) { speak('æ­å–œä½ å®Œæˆäº†æ°´çš„æ™ºæ…§å¯¹è¯ï¼åƒæ°´ä¸€æ ·æŸ”è½¯ï¼Œåƒæ°´ä¸€æ ·åšæŒï¼Œåƒæ°´ä¸€æ ·åŒ…å®¹ã€‚ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€‚'); return; }
        const node = SOCRATIC_TREE.find(n => n.id === nodeId);
        if (!node) return;
        socraticNode = nodeId;

        const chatDiv = document.getElementById('socraticChat');
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble master';
        bubble.innerHTML = `<div class="role">ğŸ›ï¸ æ°´å­¦å¯¼å¸ˆ</div>${node.text}`;
        chatDiv.appendChild(bubble);
        chatDiv.scrollTop = chatDiv.scrollHeight;

        // è‡ªåŠ¨æœ—è¯»å¯¼å¸ˆçš„è¯
        speak(node.text);

        const optDiv = document.getElementById('socraticOptions');
        optDiv.innerHTML = node.options.map((opt, i) => `<div class="socratic-opt" onclick="chooseSocratic(${nodeId}, ${i})">${opt.text}</div>`).join('');
    }

    function chooseSocratic(nodeId, optIndex) {
        const node = SOCRATIC_TREE.find(n => n.id === nodeId);
        if (!node) return;
        const opt = node.options[optIndex];

        const chatDiv = document.getElementById('socraticChat');
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble student';
        bubble.innerHTML = `<div class="role">ğŸ™‹ ä½ </div>${opt.text}`;
        chatDiv.appendChild(bubble);
        chatDiv.scrollTop = chatDiv.scrollHeight;

        document.getElementById('socraticOptions').innerHTML = '<div style="text-align:center;padding:10px;color:rgba(255,255,255,0.3);font-size:10px;">å¯¼å¸ˆæ€è€ƒä¸­...</div>';
        setTimeout(() => renderSocraticNode(opt.next), 1200);
    }

    function renderWater() { renderWaterLesson(); }

    // ==================== è¯­éŸ³å”¤é†’ç³»ç»Ÿã€Œæ™ºå›ã€ ====================
    let voiceRecognition = null;
    let isVoiceListening = false;
    let isVoiceAwake = false;

    function initVoiceSystem() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
            document.getElementById('voiceFab').style.display = 'none';
            return;
        }
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.lang = 'zh-CN';
        voiceRecognition.continuous = true;
        voiceRecognition.interimResults = true;

        voiceRecognition.onresult = function(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            transcript = transcript.toLowerCase().trim();
            showVoiceStatus('ğŸ¤ ' + transcript);

            // å”¤é†’è¯æ£€æµ‹
            if (!isVoiceAwake) {
                if (transcript.includes('æ™ºå›') || transcript.includes('çŸ¥å›') || transcript.includes('å¿—å›') || transcript.includes('ä¹‹å›')) {
                    isVoiceAwake = true;
                    speak('æˆ‘åœ¨ï¼Œè¯·å©å’');
                    showVoiceStatus('âœ… å·²å”¤é†’ï¼è¯·è¯´æŒ‡ä»¤...');
                    document.getElementById('voiceFab').classList.add('listening');
                    setTimeout(() => { isVoiceAwake = false; showVoiceStatus('ğŸ’¤ ç­‰å¾…å”¤é†’è¯ã€Œæ™ºå›ã€'); document.getElementById('voiceFab').classList.remove('listening'); }, 15000);
                }
                return;
            }

            // æŒ‡ä»¤å¤„ç†
            if (event.results[event.resultIndex].isFinal) {
                processVoiceCommand(transcript);
                isVoiceAwake = false;
                document.getElementById('voiceFab').classList.remove('listening');
                setTimeout(() => showVoiceStatus('ğŸ’¤ ç­‰å¾…å”¤é†’è¯ã€Œæ™ºå›ã€'), 3000);
            }
        };

        voiceRecognition.onend = function() {
            if (isVoiceListening) {
                try { voiceRecognition.start(); } catch(e) {}
            }
        };

        voiceRecognition.onerror = function(event) {
            if (event.error !== 'no-speech' && event.error !== 'aborted') {
                showVoiceStatus('âš ï¸ è¯­éŸ³é”™è¯¯: ' + event.error);
            }
        };
    }

    function processVoiceCommand(cmd) {
        showVoiceStatus('ğŸ”„ å¤„ç†: ' + cmd);
        
        if (cmd.includes('å‡ ç‚¹') || cmd.includes('æ—¶é—´') || cmd.includes('ç°åœ¨')) {
            const now = new Date();
            speak(`ç°åœ¨æ˜¯${now.getHours()}ç‚¹${now.getMinutes()}åˆ†${now.getSeconds()}ç§’`);
        } else if (cmd.includes('æ—¥æœŸ') || cmd.includes('ä»Šå¤©') || cmd.includes('æ˜ŸæœŸ')) {
            const now = new Date();
            const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            speak(`ä»Šå¤©æ˜¯${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼Œæ˜ŸæœŸ${weekDays[now.getDay()]}`);
        } else if (cmd.includes('å–æ°´') || cmd.includes('é¥®æ°´') || cmd.includes('æ°´äº†å—')) {
            drinkWater(250);
        } else if (cmd.includes('å–äº†å¤šå°‘') || cmd.includes('ä»Šæ—¥é¥®æ°´') || cmd.includes('å–æ°´è¿›åº¦')) {
            const percent = Math.round((waterData.today / waterData.goal) * 100);
            speak(`ä»Šæ—¥å·²å–${waterData.today}æ¯«å‡ï¼Œç›®æ ‡${waterData.goal}æ¯«å‡ï¼Œå®Œæˆ${percent}%`);
        } else if (cmd.includes('æé†’') && (cmd.includes('æ–°å»º') || cmd.includes('æ·»åŠ ') || cmd.includes('åˆ›å»º') || cmd.includes('è®¾ç½®'))) {
            openPanel('settingsPanel');
            speak('å·²æ‰“å¼€æé†’è®¾ç½®ï¼Œè¯·åˆ›å»ºæ–°æé†’');
        } else if (cmd.includes('æé†’') && cmd.includes('æŸ¥çœ‹')) {
            if (reminds.length === 0) { speak('æš‚æ— æé†’'); }
            else { speak(`ä½ æœ‰${reminds.length}ä¸ªæé†’ã€‚æœ€è¿‘çš„æ˜¯ï¼š${reminds[0].title}`); }
        } else if (cmd.includes('æ‰“å¡') || cmd.includes('ç­¾åˆ°')) {
            doCheckin();
            speak('æ‰“å¡æˆåŠŸï¼');
        } else if (cmd.includes('æ°´å­¦') || cmd.includes('æ°´è¯¾') || cmd.includes('è¯¾ç¨‹')) {
            openPanel('waterPanel');
            speak('å·²æ‰“å¼€æ°´å­¦è¯¾ç¨‹');
        } else if (cmd.includes('ç»å…¸') || cmd.includes('ç»ä¹¦') || cmd.includes('é“å¾·ç»') || cmd.includes('å¿ƒç»')) {
            openPanel('classicsPanel');
            speak('å·²æ‰“å¼€ç»å…¸');
        } else if (cmd.includes('å…³æ€€') || cmd.includes('å¥½å‹') || cmd.includes('é€šè®¯å½•')) {
            openPanel('carePanel');
            speak('å·²æ‰“å¼€æ™ºèƒ½å…³æ€€');
        } else if (cmd.includes('ç§¯åˆ†') || cmd.includes('åˆ†æ•°')) {
            speak(`ä½ å½“å‰æœ‰${checkinData.points}ç§¯åˆ†ï¼Œè¿ç»­æ‰“å¡${checkinData.streak}å¤©`);
        } else if (cmd.includes('è®¾ç½®')) {
            openPanel('settingsPanel');
            speak('å·²æ‰“å¼€è®¾ç½®');
        } else if (cmd.includes('å¯¹è¯') || cmd.includes('è‹æ ¼æ‹‰åº•') || cmd.includes('é—®ç­”')) {
            openPanel('waterPanel');
            switchWaterTab('socratic');
            speak('å·²è¿›å…¥æ°´çš„è‹æ ¼æ‹‰åº•å¯¹è¯');
        } else if (cmd.includes('æœ—è¯»') || cmd.includes('è¯»')) {
            speakWaterLesson();
        } else if (cmd.includes('å¸®åŠ©') || cmd.includes('ä½ èƒ½')) {
            speak('æˆ‘å¯ä»¥å¸®ä½ ï¼šå–æ°´ã€æŸ¥çœ‹å–æ°´è¿›åº¦ã€æŸ¥çœ‹æ—¶é—´ã€æ–°å»ºæé†’ã€æ‰“å¡ç­¾åˆ°ã€æ‰“å¼€æ°´å­¦è¯¾ç¨‹ã€æ‰“å¼€ç»å…¸ã€æŸ¥çœ‹ç§¯åˆ†ã€‚è¯´ã€Œæ™ºå›ã€å”¤é†’æˆ‘åè¯´æŒ‡ä»¤å³å¯ã€‚');
        } else {
            speak('æŠ±æ­‰æ²¡å¬æ¸…ï¼Œä½ å¯ä»¥è¯´ï¼šå–æ°´ã€å–æ°´è¿›åº¦ã€å‡ ç‚¹äº†ã€æŸ¥çœ‹æé†’ã€æ‰“å¼€æ°´å­¦ã€æˆ–è€…å¸®åŠ©');
        }
    }

    function toggleVoiceRecognition() {
        if (!voiceRecognition) {
            initVoiceSystem();
            if (!voiceRecognition) { toast('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³'); return; }
        }
        
        if (isVoiceListening) {
            isVoiceListening = false;
            voiceRecognition.stop();
            document.getElementById('voiceFab').classList.remove('listening');
            showVoiceStatus('ğŸ”‡ è¯­éŸ³å·²å…³é—­');
            setTimeout(() => document.getElementById('voiceStatus').classList.remove('show'), 2000);
            speak('è¯­éŸ³åŠ©æ‰‹å·²å…³é—­');
        } else {
            isVoiceListening = true;
            try { voiceRecognition.start(); } catch(e) {}
            showVoiceStatus('ğŸ’¤ ç­‰å¾…å”¤é†’è¯ã€Œæ™ºå›ã€');
            speak('è¯­éŸ³åŠ©æ‰‹å·²å¼€å¯ï¼Œè¯´æ™ºå›å”¤é†’æˆ‘');
        }
    }

    function showVoiceStatus(text) {
        const el = document.getElementById('voiceStatus');
        el.textContent = text;
        el.classList.add('show');
    }
    function speak(t) { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang = currentLang === 'zh' ? 'zh-CN' : currentLang === 'ja' ? 'ja-JP' : currentLang === 'ko' ? 'ko-KR' : 'en-US'; speechSynthesis.speak(u); }

    // å¥½å‹
    function addFriend() { const name = document.getElementById('fName').value.trim(); if (!name) return toast('!'); friends.push({ id: 'F' + Date.now(), name, phone: document.getElementById('fPhone').value.trim(), relation: document.getElementById('fRelation').value }); document.getElementById('fName').value = ''; saveData(); closeModal(); renderFriends(); toast('âœ…'); }
    function renderFriends() { document.getElementById('friendList').innerHTML = friends.length ? friends.map(f => `<div class="item"><div class="icon">ğŸ‘¤</div><div class="info"><div class="name">${f.name}</div><div class="desc">${f.relation}</div></div><button onclick="friends=friends.filter(x=>x.id!=='${f.id}');saveData();renderFriends();" style="background:none;border:none;color:rgba(255,255,255,0.3);font-size:14px;cursor:pointer;">Ã—</button></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }

    // ä¸»é¢˜
    function setTheme(name) { currentTheme = name; applyTheme(name); document.querySelectorAll('.theme-item').forEach(t => t.classList.remove('active')); document.querySelector(`.theme-item.${name}`)?.classList.add('active'); saveData(); toast('ğŸ¨'); }
    function applyTheme(name) { const t = THEMES[name] || THEMES.classic; document.documentElement.style.setProperty('--primary', t.primary); document.body.style.background = `linear-gradient(135deg, ${t.bg1}, ${t.bg2})`; document.getElementById('clockFace').style.borderColor = t.primary; }

    function toggleVoice() { toggleVoiceRecognition(); }

    function openPanel(id) { closeAllPanels(); document.getElementById(id).classList.add('open'); document.getElementById('overlay').classList.add('show'); if (id === 'carePanel') updateContactsUI(); }
    function closeAllPanels() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('open')); document.getElementById('overlay').classList.remove('show'); }
    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); }

    function doLogin() { const p = document.getElementById('phoneInput').value.trim(), n = document.getElementById('nameInput').value.trim(), w = document.getElementById('pwdInput').value; if (!p || p.length !== 11) return toast('!'); if (!w || w.length < 6) return toast('!'); const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}'); if (users[p]) { if (users[p].pwd !== w) return toast('âŒ'); user = users[p]; } else { if (!n) return toast('!'); user = { id: 'U' + Date.now().toString(36).toUpperCase(), phone: p, name: n, pwd: w, level: 'free' }; users[p] = user; localStorage.setItem('heshuileUsers', JSON.stringify(users)); } localStorage.setItem('currentUser', JSON.stringify(user)); updateUI(); toast('âœ…'); }
    function logout() { user = null; localStorage.removeItem('currentUser'); updateUI(); closeAllPanels(); toast('ğŸ‘‹'); }
    function upgrade() { if (!user) return; user.level = 'vip'; const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}'); users[user.phone] = user; localStorage.setItem('heshuileUsers', JSON.stringify(users)); localStorage.setItem('currentUser', JSON.stringify(user)); updateUI(); toast('ğŸ‘‘'); }
    function copyInviteLink() { if (!user) return toast('!'); navigator.clipboard.writeText(location.href.split('?')[0] + '?invite=' + user.id).then(() => toast('ğŸ“‹')); }
    function updateUI() { const btn = document.getElementById('userBtn'); if (user) { btn.textContent = user.level === 'vip' ? 'ğŸ‘‘' : 'ğŸ‘¤'; document.getElementById('loginBox').style.display = 'none'; document.getElementById('memberBox').style.display = 'block'; document.getElementById('avatar').textContent = user.name.charAt(0); document.getElementById('userName').textContent = user.name; document.getElementById('userLevel').textContent = user.level === 'vip' ? 'ğŸ‘‘ VIP' : 'Free'; document.getElementById('inviteCode').textContent = user.id; const qr = document.getElementById('promoQR'); qr.innerHTML = ''; if (typeof QRCode !== 'undefined') QRCode.toCanvas(location.href.split('?')[0] + '?invite=' + user.id, { width: 100, margin: 2 }, (e, c) => { if (!e) qr.appendChild(c); }); } else { btn.textContent = I18N[currentLang].login; document.getElementById('loginBox').style.display = 'block'; document.getElementById('memberBox').style.display = 'none'; } }

    function toast(m) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = m; document.body.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2000); }

    function saveData() { localStorage.setItem('heshuileData', JSON.stringify({ tickOn, currentTheme, currentSound, volume, friends, ads, reminds, checkinData, centerData, contactsAuthorized, contacts, waterData })); }
    function loadData() { try { const d = JSON.parse(localStorage.getItem('heshuileData')); if (d) { tickOn = d.tickOn ?? true; currentTheme = d.currentTheme || 'classic'; currentSound = d.currentSound || 'classic'; volume = d.volume ?? 50; friends = d.friends || []; ads = d.ads || ads; reminds = d.reminds || []; checkinData = d.checkinData || checkinData; centerData = d.centerData || centerData; contactsAuthorized = d.contactsAuthorized || false; contacts = d.contacts || []; waterData = d.waterData || waterData; } const u = localStorage.getItem('currentUser'); if (u) user = JSON.parse(u); } catch (e) {} }
    </script>
</body>
</html>
